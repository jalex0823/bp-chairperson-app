{% extends "base.html" %}
{% block content %}
  <div class="container py-4">
    <div class="row justify-content-center">
      <div class="col-12 col-md-10 col-lg-8 col-xl-6">
        <h2 class="mb-4 text-center">Create Back Porch Chairperson Account</h2>
        <div class="card shadow-sm">
          <div class="card-body p-4">

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ msg }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form id="registerForm" method="POST" action="{{ url_for('register') }}" class="needs-validation" novalidate>
      {{ form.hidden_tag() }}

      {% if access_codes_configured %}
      <div class="mb-4 p-3 border rounded" style="background-color: #fff3cd; border-color: #ffc107 !important;">
        <div class="d-flex align-items-center mb-2">
          <i class="fas fa-key text-warning me-2" style="font-size: 1.5rem;"></i>
          <h5 class="mb-0 text-dark">Registration Unlock Key Required</h5>
        </div>
        
        <div class="alert alert-info mb-3" role="alert" style="color: white;">
          <i class="fas fa-info-circle"></i> <strong>Registration is locked.</strong> You must enter a valid unlock key to access the registration form fields.
        </div>
        
        <label for="access_code" class="form-label fw-bold">Enter Your Unlock Key:</label>
        <div class="input-group mb-2">
          <input type="text" class="form-control" id="access_code" name="access_code" placeholder="Enter unlock key" autocomplete="off">
          <button type="button" id="unlockSubmit" class="btn btn-success">
            <i class="fas fa-unlock"></i> Submit
          </button>
          <button type="button" id="unlockClear" class="btn btn-outline-secondary">
            <i class="fas fa-times"></i> Clear
          </button>
        </div>
        <div class="form-text">Enter the unlock key to enable the registration form fields.</div>
      </div>
      {% endif %}

      <fieldset id="regFields">
        <div class="mb-3">
          {{ form.display_name.label(class_='form-label') }}
          {{ form.display_name(class_='form-control form-control-sm') }}
        </div>
        <div class="mb-3">
          {{ form.email.label(class_='form-label') }}
          {{ form.email(class_='form-control form-control-sm') }}
        </div>
        <div class="mb-3">
          {{ form.password.label(class_='form-label') }}
          {{ form.password(class_='form-control form-control-sm') }}
        </div>
        <div class="mb-3">
          {{ form.sobriety_date.label(class_='form-label') }}
          {{ form.sobriety_date(class_='form-control form-control-sm', id='sobriety_date') }}
          <div class="form-text" id="daysSoberText" style="margin-top: 0.25rem;">
            Years: <span id="yearsSoberVal">0</span> â€¢ Days: <span id="daysSoberVal">0</span>
          </div>
        </div>
        <div class="mb-3">
          {{ form.gender.label(class_='form-label') }}
          <div>
            {% for subfield in form.gender %}
              <div class="form-check form-check-inline">
                {{ subfield(class_='form-check-input', id='gender_' ~ loop.index) }}
                <label class="form-check-label" for="gender_{{ loop.index }}">{{ subfield.label.text }}</label>
              </div>
            {% endfor %}
          </div>
          <div class="form-text">Used to determine eligibility for Men-only or Women-only meetings.</div>
        </div>
        <div class="mb-3 form-check">
          {{ form.agreed_guidelines(class_='form-check-input', id='agreed_guidelines') }}
          <label class="form-check-label" for="agreed_guidelines">{{ form.agreed_guidelines.label.text }}</label>
        </div>
      </fieldset>

      {{ form.submit(class_='btn btn-primary btn-sm w-100', id='submitBtn') }}

    <!-- Modal for incorrect key / lockout -->
    <div class="modal fade" id="keyModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Registration Locked</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="keyModalBody">Incorrect key. You are locked out.</div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for successful unlock -->
    <div class="modal fade" id="keySuccessModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Registration Unlocked</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">Your unlock key is valid. You may complete the registration form now.</div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>
    </form>

    <script>
      (function() {
        const accessConfigured = {{ 'true' if access_codes_configured else 'false' }};
        const accessInput = document.getElementById('access_code');
        const regFields = document.getElementById('regFields');
        const submitBtn = document.getElementById('submitBtn');
        const sobDate = document.getElementById('sobriety_date');
        const daysVal = document.getElementById('daysSoberVal');
        const yearsVal = document.getElementById('yearsSoberVal');

        function setLockedState(locked) {
          if (!regFields) return;
          for (const el of regFields.querySelectorAll('input, select, textarea')) {
            el.disabled = locked;
          }
          if (submitBtn) submitBtn.disabled = locked;
        }

        if (accessConfigured) {
          setLockedState(true);
          const unlockBtn = document.getElementById('unlockSubmit');
          const clearBtn = document.getElementById('unlockClear');
          const modalEl = document.getElementById('keyModal');
          const modalBody = document.getElementById('keyModalBody');
          const bsModal = modalEl ? new bootstrap.Modal(modalEl) : null;
          const successModalEl = document.getElementById('keySuccessModal');
          const bsSuccessModal = successModalEl ? new bootstrap.Modal(successModalEl) : null;

          async function tryUnlock() {
            const key = (accessInput && accessInput.value ? accessInput.value.trim() : '');
            if (!key) { return; }
            try {
              const resp = await fetch('/api/registration/validate-key', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key })
              });
              const data = await resp.json();
              if (data && data.ok) {
                localStorage.setItem('bp_access_code', key);
                setLockedState(false);
                // Visual feedback
                accessInput.classList.remove('is-invalid');
                accessInput.classList.add('is-valid');
                if (bsSuccessModal) { bsSuccessModal.show(); }
              } else {
                if (bsModal && modalBody) {
                  modalBody.textContent = 'Incorrect key. You are locked out.';
                  bsModal.show();
                  // After the modal is hidden, redirect away
                  modalEl.addEventListener('hidden.bs.modal', () => {
                    window.location.href = 'https://www.google.com/';
                  }, { once: true });
                } else {
                  window.location.href = 'https://www.google.com/';
                }
                accessInput.classList.remove('is-valid');
                accessInput.classList.add('is-invalid');
              }
            } catch (e) {
              // Fail closed
              if (bsModal && modalBody) {
                modalBody.textContent = 'Unable to validate key. You are locked out.';
                bsModal.show();
                modalEl.addEventListener('hidden.bs.modal', () => {
                  window.location.href = 'https://www.google.com/';
                }, { once: true });
              } else {
                window.location.href = 'https://www.google.com/';
              }
              accessInput.classList.remove('is-valid');
              accessInput.classList.add('is-invalid');
            }
          }

          if (unlockBtn) unlockBtn.addEventListener('click', tryUnlock);
          if (clearBtn) clearBtn.addEventListener('click', function() {
            localStorage.removeItem('bp_access_code');
            if (accessInput) accessInput.value = '';
            setLockedState(true);
            accessInput.classList.remove('is-valid');
            accessInput.classList.remove('is-invalid');
          });

          // If a saved key exists, attempt auto-unlock
          const saved = localStorage.getItem('bp_access_code');
          if (saved && accessInput) {
            accessInput.value = saved;
            tryUnlock();
          }
        } else {
          setLockedState(false);
        }

        // Auto-calc days sober based on selected sobriety date
        function calcDays() {
          if (!sobDate || !daysVal) return;
          const val = sobDate.value;
          if (!val) { daysVal.textContent = '0'; if (yearsVal) yearsVal.textContent = '0'; return; }
          const d0 = new Date(val + 'T00:00:00');
          const today = new Date();
          // Normalize to midnight (UTC) to avoid timezone day drift
          const start = new Date(Date.UTC(d0.getFullYear(), d0.getMonth(), d0.getDate()));
          const current = new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate()));

          // Compute whole years using calendar anniversaries
          let years = current.getUTCFullYear() - start.getUTCFullYear();
          const anniversaryThisYear = new Date(Date.UTC(current.getUTCFullYear(), start.getUTCMonth(), start.getUTCDate()));
          if (current < anniversaryThisYear) {
            years = Math.max(0, years - 1);
          }

          // Compute remainder days since last anniversary
          const lastAnniversaryYear = start.getUTCFullYear() + years;
          const lastAnniversary = new Date(Date.UTC(lastAnniversaryYear, start.getUTCMonth(), start.getUTCDate()));
          const diffMs = Math.max(0, current - lastAnniversary);
          const remainderDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

          yearsVal.textContent = years.toString();
          daysVal.textContent = remainderDays.toString();
        }
        if (sobDate) {
          sobDate.addEventListener('change', calcDays);
          sobDate.addEventListener('input', calcDays);
          calcDays();
        }
      })();
    </script>

    <div class="mt-4">
      <hr />
      <p class="mb-2">Chairperson resources (PDFs):</p>
      {% if pdfs and pdfs|length > 0 %}
        <ul class="mb-0">
          {% for p in pdfs %}
            <li><a href="{{ p.url }}" target="_blank" rel="noopener">{{ p.name }}</a></li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted mb-0">No PDFs found. Add files to the configured folder and they will appear here.</p>
      {% endif %}
    </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
