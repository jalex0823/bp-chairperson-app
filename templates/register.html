{% extends "base.html" %}
{% block content %}
  <div class="container py-4">
    <div class="row justify-content-center">
      <div class="col-12 col-md-10 col-lg-8 col-xl-6">
        <h2 class="mb-4 text-center">Create Back Porch Chairperson Account</h2>
        
        <!-- Registration Instructions Alert -->
        <div class="alert alert-light border mb-4" role="alert" style="background-color: white; color: black;">
          <h6><i class="fas fa-info-circle"></i> New to Chairing Back Porch Meetings?</h6>
          <p class="mb-2">Learn about the registration process, requirements, and what to expect as a chairperson.</p>
          <a href="{{ url_for('registration_instructions') }}" class="btn btn-sm btn-outline-dark">
            <i class="fas fa-book-open"></i> View Registration Instructions
          </a>
        </div>
        
        <div class="card shadow-sm" style="background-color: white;">
          <div class="card-body p-4" style="color: black;">

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ msg }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form id="registerForm" method="POST" action="{{ url_for('register') }}" class="needs-validation" novalidate>
      {{ form.hidden_tag() }}

      {% if access_codes_configured %}
      <div class="mb-3">
        <label for="access_code" class="form-label">Registration Unlock Key:</label>
        <div class="input-group input-group-sm">
          {{ form.access_code(class='form-control form-control-sm', id='access_code', placeholder='Enter unlock key', autocomplete='off') }}
          <button type="button" id="unlockSubmit" class="btn btn-success btn-sm">Submit</button>
          <button type="button" id="unlockClear" class="btn btn-outline-secondary btn-sm">Delete</button>
        </div>
        <div class="form-text">Enter the unlock key to enable the registration form fields.</div>
        <div id="unlockStatus" class="mt-2" style="display: none;">
          <span class="badge bg-success">✓ Form Unlocked</span>
        </div>
      </div>
      {% endif %}

      <fieldset id="regFields">
        <div class="mb-3">
          {{ form.display_name.label(class_='form-label') }}
          {{ form.display_name(class_='form-control form-control-sm') }}
        </div>
        <div class="mb-3">
          {{ form.email.label(class_='form-label') }}
          {{ form.email(class_='form-control form-control-sm') }}
        </div>
        <div class="mb-3">
          {{ form.password.label(class_='form-label') }}
          {{ form.password(class_='form-control form-control-sm') }}
        </div>
        <div class="mb-3">
          {{ form.sobriety_date.label(class_='form-label') }}
          {{ form.sobriety_date(class_='form-control form-control-sm', id='sobriety_date') }}
          <div class="form-text" id="daysSoberText" style="margin-top: 0.25rem;">
            Years: <span id="yearsSoberVal">0</span> • Days: <span id="daysSoberVal">0</span>
          </div>
        </div>
        <div class="mb-3">
          {{ form.gender.label(class_='form-label') }}
          <div>
            {% for subfield in form.gender %}
              <div class="form-check form-check-inline">
                {{ subfield(class_='form-check-input', id='gender_' ~ loop.index) }}
                <label class="form-check-label" for="gender_{{ loop.index }}">{{ subfield.label.text }}</label>
              </div>
            {% endfor %}
          </div>
          <div class="form-text">Used to determine eligibility for Men-only or Women-only meetings.</div>
        </div>
        <div class="mb-3 form-check">
          {{ form.agreed_guidelines(class_='form-check-input', id='agreed_guidelines') }}
          <label class="form-check-label" for="agreed_guidelines">{{ form.agreed_guidelines.label.text }}</label>
        </div>
      </fieldset>

      {{ form.submit(class_='btn btn-primary btn-sm w-100', id='submitBtn') }}

    <!-- Modal for incorrect key warning -->
    <div class="modal fade" id="keyModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-warning">
            <h5 class="modal-title text-dark"><i class="fas fa-exclamation-triangle"></i> Incorrect Unlock Key</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="keyModalBody" style="color: black;">
            <p class="mb-2"><strong>The unlock key you entered is incorrect.</strong></p>
            <p class="mb-0">Remaining attempts: <span id="remainingAttempts" class="fw-bold text-danger">2</span></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Try Again</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for successful unlock -->
    <div class="modal fade" id="keySuccessModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Registration Unlocked</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="text-success mb-3">
              <i class="fas fa-check-circle fa-2x"></i>
            </div>
            <p class="mb-0">Your unlock key is valid! The registration form fields are now unlocked and you may complete your registration.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>
    </form>

    <script>
      (function() {
        const accessConfigured = {{ 'true' if access_codes_configured else 'false' }};
        const accessInput = document.getElementById('access_code');
        const regFields = document.getElementById('regFields');
        const submitBtn = document.getElementById('submitBtn');
        const sobDate = document.getElementById('sobriety_date');
        const daysVal = document.getElementById('daysSoberVal');
        const yearsVal = document.getElementById('yearsSoberVal');
        const unlockStatus = document.getElementById('unlockStatus');
        let failedAttempts = 0;

        function setLockedState(locked) {
          if (!regFields) return;
          for (const el of regFields.querySelectorAll('input, select, textarea')) {
            el.disabled = locked;
          }
          if (submitBtn) submitBtn.disabled = locked;
        }

        if (accessConfigured) {
          setLockedState(true);
          const unlockBtn = document.getElementById('unlockSubmit');
          const clearBtn = document.getElementById('unlockClear');
          const modalEl = document.getElementById('keyModal');
          const modalBody = document.getElementById('keyModalBody');
          const bsModal = modalEl ? new bootstrap.Modal(modalEl) : null;
          const successModalEl = document.getElementById('keySuccessModal');
          const bsSuccessModal = successModalEl ? new bootstrap.Modal(successModalEl) : null;

          // Add manual close handler for success modal fallback
          if (successModalEl) {
            const closeButtons = successModalEl.querySelectorAll('[data-bs-dismiss="modal"], .btn-close');
            closeButtons.forEach(btn => {
              btn.addEventListener('click', () => {
                if (bsSuccessModal) {
                  bsSuccessModal.hide();
                } else {
                  // Manual hide
                  successModalEl.style.display = 'none';
                  successModalEl.classList.remove('show');
                  successModalEl.setAttribute('aria-hidden', 'true');
                  successModalEl.removeAttribute('aria-modal');
                }
              });
            });
          }

          async function tryUnlock() {
            const key = (accessInput && accessInput.value ? accessInput.value.trim() : '');
            if (!key) { return; }
            try {
              const resp = await fetch('/api/registration/validate-key', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key })
              });
              const data = await resp.json();
              if (data && data.ok) {
                localStorage.setItem('bp_access_code', key);
                setLockedState(false);
                // Visual feedback
                accessInput.classList.remove('is-invalid');
                accessInput.classList.add('is-valid');
                
                // Show unlock status
                if (unlockStatus) {
                  unlockStatus.style.display = 'block';
                }
                
                // Show success modal
                if (bsSuccessModal) { 
                  bsSuccessModal.show(); 
                } else if (successModalEl) {
                  // Fallback: try to show modal without Bootstrap if it's not loaded
                  successModalEl.style.display = 'block';
                  successModalEl.classList.add('show');
                  successModalEl.setAttribute('aria-modal', 'true');
                  successModalEl.removeAttribute('aria-hidden');
                  
                  // Auto-hide after 3 seconds
                  setTimeout(() => {
                    successModalEl.style.display = 'none';
                    successModalEl.classList.remove('show');
                    successModalEl.setAttribute('aria-hidden', 'true');
                    successModalEl.removeAttribute('aria-modal');
                  }, 3000);
                } else {
                  // Final fallback: simple alert
                  alert('Registration form unlocked! You may now complete the form.');
                }
              } else {
                // Incorrect key - increment attempts
                failedAttempts++;
                accessInput.classList.remove('is-valid');
                accessInput.classList.add('is-invalid');
                
                if (failedAttempts >= 3) {
                  // 3rd wrong attempt - redirect to google
                  window.location.href = 'https://www.google.com/';
                } else {
                  // Show warning modal with remaining attempts
                  const remainingSpan = document.getElementById('remainingAttempts');
                  if (remainingSpan) {
                    remainingSpan.textContent = (3 - failedAttempts).toString();
                  }
                  if (bsModal) {
                    bsModal.show();
                  }
                }
              }
            } catch (e) {
              // Fail closed - count as failed attempt
              failedAttempts++;
              accessInput.classList.remove('is-valid');
              accessInput.classList.add('is-invalid');
              
              if (failedAttempts >= 3) {
                window.location.href = 'https://www.google.com/';
              } else {
                const remainingSpan = document.getElementById('remainingAttempts');
                if (remainingSpan) {
                  remainingSpan.textContent = (3 - failedAttempts).toString();
                }
                if (bsModal) {
                  bsModal.show();
                }
              }
            }
          }

          if (unlockBtn) unlockBtn.addEventListener('click', tryUnlock);
          if (clearBtn) clearBtn.addEventListener('click', function() {
            localStorage.removeItem('bp_access_code');
            if (accessInput) accessInput.value = '';
            setLockedState(true);
            accessInput.classList.remove('is-valid');
            accessInput.classList.remove('is-invalid');
            // Hide unlock status
            if (unlockStatus) {
              unlockStatus.style.display = 'none';
            }
          });

          // If a saved key exists, attempt auto-unlock
          const saved = localStorage.getItem('bp_access_code');
          if (saved && accessInput) {
            accessInput.value = saved;
            tryUnlock();
          }
        } else {
          setLockedState(false);
        }

        // Auto-calc days sober based on selected sobriety date
        function calcDays() {
          if (!sobDate || !daysVal) return;
          const val = sobDate.value;
          if (!val) { daysVal.textContent = '0'; if (yearsVal) yearsVal.textContent = '0'; return; }
          const d0 = new Date(val + 'T00:00:00');
          const today = new Date();
          // Normalize to midnight (UTC) to avoid timezone day drift
          const start = new Date(Date.UTC(d0.getFullYear(), d0.getMonth(), d0.getDate()));
          const current = new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate()));

          // Compute whole years using calendar anniversaries
          let years = current.getUTCFullYear() - start.getUTCFullYear();
          const anniversaryThisYear = new Date(Date.UTC(current.getUTCFullYear(), start.getUTCMonth(), start.getUTCDate()));
          if (current < anniversaryThisYear) {
            years = Math.max(0, years - 1);
          }

          // Compute remainder days since last anniversary
          const lastAnniversaryYear = start.getUTCFullYear() + years;
          const lastAnniversary = new Date(Date.UTC(lastAnniversaryYear, start.getUTCMonth(), start.getUTCDate()));
          const diffMs = Math.max(0, current - lastAnniversary);
          const remainderDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

          yearsVal.textContent = years.toString();
          daysVal.textContent = remainderDays.toString();
        }
        if (sobDate) {
          sobDate.addEventListener('change', calcDays);
          sobDate.addEventListener('input', calcDays);
          calcDays();
        }
      })();
    </script>

    <div class="mt-4">
      <hr />
      <p class="mb-2">Chairperson resources (PDFs):</p>
      {% if pdfs and pdfs|length > 0 %}
        <ul class="mb-0">
          {% for p in pdfs %}
            <li><a href="{{ p.url }}" target="_blank" rel="noopener">{{ p.name }}</a></li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted mb-0">No PDFs found. Add files to the configured folder and they will appear here.</p>
      {% endif %}
    </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
