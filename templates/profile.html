{% extends 'base.html' %}
{% block content %}
<div class="container my-4">
  <!-- Header with Refresh Button -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="mb-0"><i class="fas fa-user-circle"></i> My Profile</h2>
        <div class="d-flex gap-2">
          <a class="btn btn-success" href="{{ url_for('profile_refresh') }}" title="Refresh profile data">
            <i class="fas fa-sync-alt"></i> Refresh Data
          </a>
          <a class="btn btn-outline-primary" href="{{ url_for('dashboard') }}">
            <i class="fas fa-tachometer-alt"></i> Dashboard
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Profile Information Column -->
    <div class="col-lg-4 mb-4">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0"><i class="fas fa-user"></i> Profile Information</h4>
        </div>
        <div class="card-body">
          <form method="post" enctype="multipart/form-data">
            {{ form.hidden_tag() }}
            
            <!-- Profile Image Section -->
            <div class="mb-3 text-center">
              {% if user.profile_image %}
                <img src="{{ url_for('profile_image', user_id=user.id) }}" 
                     alt="{{ user.display_name }}" 
                     class="rounded-circle mb-2" 
                     style="width: 120px; height: 120px; object-fit: cover; border: 3px solid #007bff;">
              {% else %}
                <div class="rounded-circle bg-secondary d-inline-flex align-items-center justify-content-center mb-2" 
                     style="width: 120px; height: 120px; border: 3px solid #6c757d;">
                  <i class="fas fa-user fa-3x text-white"></i>
                </div>
              {% endif %}
              <div class="mt-2">
                {{ form.profile_image.label(class="form-label") }}
                {{ form.profile_image(class="form-control form-control-sm") }}
                <div class="form-text">Upload a profile picture (PNG, JPG, GIF, WEBP - Max 5MB)</div>
              </div>
            </div>

            <div class="mb-3">
              {{ form.display_name.label(class="form-label fw-bold") }}
              {{ form.display_name(class="form-control") }}
            </div>

            <div class="mb-3">
              {{ form.gender.label(class="form-label fw-bold") }}
              <div class="mt-2">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="gender" id="genderMale" value="male" {% if form.gender.data == 'male' %}checked{% endif %}>
                  <label class="form-check-label" for="genderMale">Male</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="gender" id="genderFemale" value="female" {% if form.gender.data == 'female' %}checked{% endif %}>
                  <label class="form-check-label" for="genderFemale">Female</label>
                </div>
              </div>
              <div class="form-text">Used to determine eligibility for Men-only or Women-only meetings.</div>
            </div>

            <div class="d-grid gap-2">
              {{ form.submit(class="btn btn-primary") }}
              <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">Back to Dashboard</a>
            </div>
          </form>
        </div>
      </div>

      <!-- Quick Stats Card -->
      <div class="card mt-3">
        <div class="card-header bg-info text-white">
          <h6 class="mb-0"><i class="fas fa-chart-bar"></i> Your Service Stats</h6>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6">
              <div class="h4 text-primary mb-0">{{ upcoming_meetings|length }}</div>
              <small class="text-muted">Upcoming<br>Meetings</small>
            </div>
            <div class="col-6">
              <div class="h4 text-success mb-0">{{ past_meetings|length }}</div>
              <small class="text-muted">Completed<br>Meetings</small>
            </div>
          </div>
          <hr class="my-2">
          <div class="row text-center">
            <div class="col-6">
              <div class="h3 mb-0" style="background: linear-gradient(135deg, #FFD700, #FFA500); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                <i class="fas fa-star"></i> <span id="chairPointsValue">{{ user.chair_points or 0 }}</span>
              </div>
              <small class="text-muted">ChairPoints™</small>
            </div>
            <div class="col-6">
              <div class="h5 text-warning mb-0">{{ upcoming_availability|length }}</div>
              <small class="text-muted">Volunteer Signups</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Chairperson Resources Card -->
      <div class="card mt-3">
        <div class="card-header bg-primary text-white">
          <h6 class="mb-0"><i class="fas fa-book"></i> Chairperson Resources</h6>
        </div>
        <div class="card-body p-3">
          <div class="d-grid gap-2">
            <a href="{{ url_for('calendar_export') }}" class="btn btn-sm btn-success">
              <i class="fas fa-calendar-download"></i> Export My Calendar
            </a>
            <a href="{{ url_for('serve_pdf', filename='Guidelines_for_Chairpersons.pdf') }}" target="_blank" class="btn btn-sm btn-outline-primary">
              <i class="fas fa-file-pdf"></i> Guidelines for Chairpersons
            </a>
            <a href="{{ url_for('serve_pdf', filename='Zoom_Chairperson_Meeting_Guide.pdf') }}" target="_blank" class="btn btn-sm btn-outline-info">
              <i class="fas fa-video"></i> Zoom Meeting Guide
            </a>
            <a href="{{ url_for('serve_pdf', filename='Back Porch Meeting Format - Rev 12-5-25.pdf') }}" target="_blank" class="btn btn-sm btn-outline-success">
              <i class="fas fa-list"></i> Meeting Format
            </a>
            <a href="{{ url_for('host_signup_instructions') }}" class="btn btn-sm btn-outline-secondary">
              <i class="fas fa-question-circle"></i> Host Instructions
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Meeting Commitments Column -->
    <div class="col-lg-8">
      <!-- Search and Filter Section -->
      <div class="card mb-3">
        <div class="card-header bg-light">
          <h6 class="mb-0"><i class="fas fa-search"></i> Filter Your Meeting History</h6>
        </div>
        <div class="card-body">
          <form method="GET" class="row g-2">
            <div class="col-md-4">
              <input type="text" class="form-control form-control-sm" name="search" 
                     value="{{ current_filters.search }}" 
                     placeholder="Search meetings...">
            </div>
            
            <div class="col-md-3">
              <select class="form-select form-select-sm" name="meeting_type">
                <option value="">All Types</option>
                {% for mt in user_meeting_types %}
                  <option value="{{ mt }}" {% if current_filters.meeting_type == mt %}selected{% endif %}>{{ mt }}</option>
                {% endfor %}
              </select>
            </div>
            
            <div class="col-md-2">
              <input type="date" class="form-control form-control-sm" name="date_from" 
                     value="{{ current_filters.date_from }}" placeholder="From">
            </div>
            
            <div class="col-md-2">
              <input type="date" class="form-control form-control-sm" name="date_to" 
                     value="{{ current_filters.date_to }}" placeholder="To">
            </div>
            
            <div class="col-md-1">
              <button type="submit" class="btn btn-primary btn-sm w-100">
                <i class="fas fa-search"></i>
              </button>
            </div>
            
            {% if current_filters.search or current_filters.meeting_type or current_filters.date_from or current_filters.date_to %}
            <div class="col-12">
              <small class="text-muted">
                <i class="fas fa-filter"></i> Filters active. 
                <a href="{{ url_for('profile') }}" class="text-decoration-none">Clear all</a>
              </small>
            </div>
            {% endif %}
          </form>
        </div>
      </div>
      
      <!-- Upcoming Meetings -->
      <div class="card mb-4">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
          <h4 class="mb-0"><i class="fas fa-calendar-check"></i> Upcoming Meetings You're Chairing</h4>
          <span class="badge bg-light text-dark">{{ upcoming_meetings|length }}</span>
        </div>
        <div class="card-body">
          {% if upcoming_meetings %}
            <div class="mb-3">
              <div class="alert alert-info py-2" role="alert">
                <small><i class="fas fa-lightbulb"></i> <strong>Preparation Tip:</strong> Review the 
                <a href="{{ url_for('serve_pdf', filename='Guidelines_for_Chairpersons.pdf') }}" target="_blank">Chairperson Guidelines</a> 
                and <a href="{{ url_for('serve_pdf', filename='Zoom_Chairperson_Meeting_Guide.pdf') }}" target="_blank">Zoom Guide</a> 
                before your meetings.</small>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Meeting</th>
                    <th>Type</th>
                    <th>Duration</th>
                    <th>Zoom</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for signup in upcoming_meetings %}
                    {% set meeting = signup.meeting %}
                    <tr>
                      <td>
                        <strong>{{ meeting.event_date.strftime('%a, %b %d') }}</strong><br>
                        <small class="text-muted">{{ meeting.event_date.strftime('%Y') }}</small>
                      </td>
                      <td>
                        <strong>{{ meeting.start_time.strftime('%I:%M %p') }}</strong>
                        {% if meeting.end_time %}
                          <br><small class="text-muted">to {{ meeting.end_time.strftime('%I:%M %p') }}</small>
                        {% endif %}
                      </td>
                      <td>
                        <strong>{{ meeting.title }}</strong>
                        {% if meeting.description %}
                          <br><small class="text-muted">{{ meeting.description }}</small>
                        {% endif %}
                      </td>
                      <td>
                        <span class="badge {{ meeting.type_badge_class }}">
                          <i class="{{ meeting.type_icon }}"></i> {{ meeting.meeting_type }}
                        </span>
                      </td>
                      <td>
                        {% if meeting.end_time %}
                          {% set duration = ((meeting.end_time.hour * 60 + meeting.end_time.minute) - (meeting.start_time.hour * 60 + meeting.start_time.minute)) %}
                          {% if duration > 0 %}
                            {% set hours = duration // 60 %}
                            {% set minutes = duration % 60 %}
                            {{ hours }}h {{ minutes }}m
                          {% else %}
                            <span class="text-muted">—</span>
                          {% endif %}
                        {% else %}
                          <span class="text-muted">Not specified</span>
                        {% endif %}
                      </td>
                      <td>
                        <a href="https://therealbackporch.com/meetings.html" target="_blank" class="btn btn-sm btn-outline-primary">
                          <i class="fas fa-video"></i> Join
                        </a>
                      </td>
                      <td>
                        <form method="POST" action="{{ url_for('cancel_chair_signup', meeting_id=meeting.id) }}" style="display: inline;">
                          <button type="submit" class="btn btn-sm btn-outline-danger" 
                                  onclick="return confirm('Are you sure you want to withdraw from chairing this meeting?');">
                            <i class="fas fa-times"></i> Withdraw
                          </button>
                        </form>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center text-muted py-4">
              <i class="fas fa-calendar-plus fa-3x mb-3"></i>
              <h5>No upcoming meetings</h5>
              <p>Visit the <a href="{{ url_for('calendar_view') }}">calendar</a> to sign up for meetings or volunteer for dates.</p>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Volunteer Availability -->
      <div class="card mb-4">
        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
          <h4 class="mb-0"><i class="fas fa-hand"></i> Your Volunteer Availability</h4>
          <span class="badge bg-dark">{{ upcoming_availability|length }}</span>
        </div>
        <div class="card-body">
          {% if upcoming_availability %}
            <div class="row">
              {% for availability in upcoming_availability %}
                <div class="col-md-6 mb-3">
                  <div class="card border-warning">
                    <div class="card-body p-3">
                      <h6 class="card-title mb-2">
                        <i class="fas fa-calendar-day text-warning"></i>
                        {{ availability.volunteer_date.strftime('%A, %B %d, %Y') }}
                      </h6>
                      <p class="card-text mb-2">
                        <small class="text-muted">
                          <i class="fas fa-clock"></i> 
                          Time preference: {{ availability.time_preference.title() }}
                        </small>
                      </p>
                      {% if availability.notes %}
                        <p class="card-text">
                          <small><strong>Notes:</strong> {{ availability.notes }}</small>
                        </p>
                      {% endif %}
                      <small class="text-muted">
                        Volunteered {{ availability.created_at.strftime('%b %d at %I:%M %p') }}
                      </small>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-center text-muted py-4">
              <i class="fas fa-hand fa-3x mb-3"></i>
              <h5>No volunteer signups</h5>
              <p>Click on dates in the <a href="{{ url_for('calendar_view') }}">calendar</a> to volunteer for chairperson duties.</p>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Past Meetings -->
      {% if past_meetings %}
      <div class="card">
        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
          <h4 class="mb-0"><i class="fas fa-history"></i> Past Meetings</h4>
          <span class="badge bg-light text-dark">{{ past_meetings|length }}</span>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm mb-0">
              <thead class="table-light">
                <tr>
                  <th>Date</th>
                  <th>Meeting</th>
                  <th>Type</th>
                  <th>Duration</th>
                </tr>
              </thead>
              <tbody>
                {% for signup in past_meetings %}
                  {% set meeting = signup.meeting %}
                  <tr>
                    <td>{{ meeting.event_date.strftime('%b %d, %Y') }}</td>
                    <td>
                      {{ meeting.title }}
                      <br><small class="text-muted">{{ meeting.start_time.strftime('%I:%M %p') }}</small>
                    </td>
                    <td>
                      <span class="badge {{ meeting.type_badge_class }}">
                        <i class="{{ meeting.type_icon }}"></i> {{ meeting.meeting_type }}
                      </span>
                    </td>
                    <td>
                      {% if meeting.end_time %}
                        {% set duration = ((meeting.end_time.hour * 60 + meeting.end_time.minute) - (meeting.start_time.hour * 60 + meeting.start_time.minute)) %}
                        {% if duration > 0 %}
                          {% set hours = duration // 60 %}
                          {% set minutes = duration % 60 %}
                          {{ hours }}h {{ minutes }}m
                        {% else %}
                          —
                        {% endif %}
                      {% else %}
                        <span class="text-muted">—</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<style>
.card-header {
  border-bottom: 2px solid rgba(255,255,255,0.2);
}

.table th {
  border-top: none;
  font-weight: 600;
  font-size: 0.9rem;
}

.btn-sm {
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
}

.badge {
  font-size: 0.8rem;
}

.card-title {
  color: #495057;
}

@media (max-width: 768px) {
  .table-responsive table {
    font-size: 0.9rem;
  }
}
</style>

<!-- Enhanced search functionality -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-submit form on filter changes (but not search input)
    const filterInputs = document.querySelectorAll('select[name="meeting_type"]');
    filterInputs.forEach(input => {
        input.addEventListener('change', function() {
            this.form.submit();
        });
    });
    
    // Debounced search
    const searchInput = document.querySelector('input[name="search"]');
    let searchTimeout;
    
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                // Only submit if search has 3+ characters or is empty
                if (this.value.length >= 3 || this.value.length === 0) {
                    this.form.submit();
                }
            }, 500);
        });
    }
    
    // Date range validation
    const dateFromInput = document.querySelector('input[name="date_from"]');
    const dateToInput = document.querySelector('input[name="date_to"]');
    
    if (dateFromInput && dateToInput) {
        dateFromInput.addEventListener('change', function() {
            if (dateToInput.value && this.value > dateToInput.value) {
                alert('Start date cannot be after end date');
                this.value = '';
            } else if (this.value) {
                this.form.submit();
            }
        });
        
        dateToInput.addEventListener('change', function() {
            if (dateFromInput.value && this.value < dateFromInput.value) {
                alert('End date cannot be before start date');
                this.value = '';
            } else if (this.value) {
                this.form.submit();
            }
        });
    }
});
</script>
{% endblock %}
