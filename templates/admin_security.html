{% extends "base.html" %}
{% block content %}
<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-shield-alt"></i> Security Dashboard</h2>
    <div>
      <button class="btn btn-warning btn-sm" onclick="createBackup()">
        <i class="fas fa-database"></i> Create Backup
      </button>
      <a href="{{ url_for('admin_meetings') }}" class="btn btn-outline-secondary btn-sm">
        <i class="fas fa-arrow-left"></i> Back to Admin
      </a>
    </div>
  </div>

  <!-- Security Overview Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white">
        <div class="card-body text-center">
          <i class="fas fa-users fa-2x mb-2"></i>
          <h3 class="mb-1">{{ total_users }}</h3>
          <small>Total Users</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white">
        <div class="card-body text-center">
          <i class="fas fa-clock fa-2x mb-2"></i>
          <h3 class="mb-1">{{ active_sessions }}</h3>
          <small>Active Sessions</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-dark">
        <div class="card-body text-center">
          <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
          <h3 class="mb-1">{{ failed_logins_today }}</h3>
          <small>Failed Logins Today</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info text-white">
        <div class="card-body text-center">
          <i class="fas fa-database fa-2x mb-2"></i>
          <h3 class="mb-1">{{ recent_backups }}</h3>
          <small>Backups This Week</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs for different sections -->
  <ul class="nav nav-tabs" id="securityTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="audit-tab" data-bs-toggle="tab" data-bs-target="#audit" type="button" role="tab">
        <i class="fas fa-list"></i> Audit Log
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
        <i class="fas fa-users"></i> User Management
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="backups-tab" data-bs-toggle="tab" data-bs-target="#backups" type="button" role="tab">
        <i class="fas fa-database"></i> Backups
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
        <i class="fas fa-cog"></i> Settings
      </button>
    </li>
  </ul>

  <div class="tab-content" id="securityTabsContent">
    <!-- Audit Log Tab -->
    <div class="tab-pane fade show active" id="audit" role="tabpanel">
      <div class="card mt-3">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Recent Audit Events</h5>
          <button class="btn btn-sm btn-light" onclick="refreshAuditLog()">
            <i class="fas fa-sync"></i> Refresh
          </button>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
              <thead class="table-dark">
                <tr>
                  <th>Timestamp</th>
                  <th>User</th>
                  <th>Action</th>
                  <th>Resource</th>
                  <th>IP Address</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody>
                {% for log in audit_logs %}
                <tr>
                  <td><small>{{ log.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</small></td>
                  <td>
                    {% if log.user %}
                      <strong>{{ log.user.display_name }}</strong><br>
                      <small class="text-muted">{{ log.user.email }}</small>
                    {% else %}
                      <em class="text-muted">System</em>
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge {% if log.action.startswith('login_success') %}bg-success{% elif log.action.startswith('login_failure') or log.action.startswith('account_locked') %}bg-danger{% elif log.action.startswith('logout') %}bg-secondary{% else %}bg-info{% endif %}">
                      {{ log.action }}
                    </span>
                  </td>
                  <td>
                    {% if log.resource_type %}
                      {{ log.resource_type }}
                      {% if log.resource_id %}#{{ log.resource_id }}{% endif %}
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td><code>{{ log.ip_address or '-' }}</code></td>
                  <td>
                    {% if log.details %}
                      <button class="btn btn-sm btn-outline-info" onclick="showDetails({{ log.details | tojson }})">
                        <i class="fas fa-eye"></i>
                      </button>
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- User Management Tab -->
    <div class="tab-pane fade" id="users" role="tabpanel">
      <div class="card mt-3">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">User Management</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>User</th>
                  <th>Roles</th>
                  <th>Last Login</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for user in users %}
                <tr>
                  <td>
                    <strong>{{ user.display_name }}</strong><br>
                    <small class="text-muted">{{ user.email }}</small>
                  </td>
                  <td>
                    {% if user.is_admin %}
                      <span class="badge bg-danger">Admin</span>
                    {% endif %}
                    {% for role in user.roles %}
                      {% if role.is_active %}
                        <span class="badge bg-info">{{ role.role }}</span>
                      {% endif %}
                    {% endfor %}
                  </td>
                  <td>
                    {% if user.last_login %}
                      {{ user.last_login.strftime('%Y-%m-%d %H:%M') }}
                    {% else %}
                      <span class="text-muted">Never</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if user.is_locked() %}
                      <span class="badge bg-danger">Locked</span>
                    {% elif user.failed_login_attempts > 0 %}
                      <span class="badge bg-warning">{{ user.failed_login_attempts }} attempts</span>
                    {% else %}
                      <span class="badge bg-success">Active</span>
                    {% endif %}
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      {% if user.is_locked() %}
                        <button class="btn btn-outline-success" onclick="unlockUser({{ user.id }})">
                          <i class="fas fa-unlock"></i> Unlock
                        </button>
                      {% endif %}
                      <button class="btn btn-outline-info" onclick="viewUserActivity({{ user.id }})">
                        <i class="fas fa-history"></i> Activity
                      </button>
                      {% if not user.is_admin %}
                        <button class="btn btn-outline-warning" onclick="manageUserRoles({{ user.id }})">
                          <i class="fas fa-user-cog"></i> Roles
                        </button>
                      {% endif %}
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Backups Tab -->
    <div class="tab-pane fade" id="backups" role="tabpanel">
      <div class="card mt-3">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Database Backups</h5>
          <div>
            <button class="btn btn-sm btn-warning" onclick="createBackup()">
              <i class="fas fa-database"></i> Create Backup
            </button>
            <button class="btn btn-sm btn-light" onclick="scheduleBackup()">
              <i class="fas fa-clock"></i> Schedule
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Status</th>
                  <th>Size</th>
                  <th>Initiated By</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for backup in backup_logs %}
                <tr>
                  <td>{{ backup.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                  <td>
                    <span class="badge {% if backup.backup_type == 'manual' %}bg-primary{% elif backup.backup_type == 'scheduled' %}bg-info{% else %}bg-secondary{% endif %}">
                      {{ backup.backup_type }}
                    </span>
                  </td>
                  <td>
                    <span class="badge {% if backup.status == 'completed' %}bg-success{% elif backup.status == 'failed' %}bg-danger{% else %}bg-warning{% endif %}">
                      {{ backup.status }}
                    </span>
                  </td>
                  <td>
                    {% if backup.file_size %}
                      {{ (backup.file_size / 1024 / 1024) | round(2) }} MB
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if backup.initiated_by_user %}
                      {{ backup.initiated_by_user.display_name }}
                    {% else %}
                      <em class="text-muted">System</em>
                    {% endif %}
                  </td>
                  <td>
                    {% if backup.status == 'completed' %}
                      <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-success" onclick="verifyBackup('{{ backup.checksum }}')">
                          <i class="fas fa-check"></i> Verify
                        </button>
                      </div>
                    {% elif backup.status == 'failed' %}
                      <button class="btn btn-outline-danger btn-sm" onclick="showBackupError('{{ backup.error_message }}')">
                        <i class="fas fa-exclamation-triangle"></i> Error
                      </button>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div class="tab-pane fade" id="settings" role="tabpanel">
      <div class="card mt-3">
        <div class="card-header bg-secondary text-white">
          <h5 class="mb-0">Security Settings</h5>
        </div>
        <div class="card-body">
          <form id="securitySettingsForm">
            <div class="row">
              <div class="col-md-6">
                <h6>Account Security</h6>
                <div class="mb-3">
                  <label class="form-label">Max Failed Login Attempts</label>
                  <input type="number" class="form-control" value="5" min="3" max="10">
                  <small class="form-text">Account will be locked after this many failed attempts</small>
                </div>
                <div class="mb-3">
                  <label class="form-label">Account Lock Duration (minutes)</label>
                  <input type="number" class="form-control" value="30" min="10" max="1440">
                </div>
                <div class="mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="requireEmailVerification">
                    <label class="form-check-label">Require email verification for new accounts</label>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <h6>Backup Settings</h6>
                <div class="mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="autoBackup" checked>
                    <label class="form-check-label">Enable automatic daily backups</label>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Backup Retention (days)</label>
                  <input type="number" class="form-control" value="30" min="7" max="365">
                </div>
                <div class="mb-3">
                  <label class="form-label">Backup Time (UTC)</label>
                  <input type="time" class="form-control" value="02:00">
                </div>
              </div>
            </div>
            <hr>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-primary" onclick="saveSecuritySettings()">
                <i class="fas fa-save"></i> Save Settings
              </button>
              <button type="button" class="btn btn-outline-secondary" onclick="resetSettings()">
                <i class="fas fa-undo"></i> Reset to Defaults
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Event Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <pre id="detailsContent"></pre>
      </div>
    </div>
  </div>
</div>

<script>
function showDetails(details) {
  document.getElementById('detailsContent').textContent = JSON.stringify(details, null, 2);
  new bootstrap.Modal(document.getElementById('detailsModal')).show();
}

function createBackup() {
  if (confirm('Create a manual database backup? This may take a few moments.')) {
    fetch('/admin/security/backup', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Backup created successfully!');
        location.reload();
      } else {
        alert('Backup failed: ' + data.error);
      }
    })
    .catch(error => {
      alert('Error creating backup: ' + error);
    });
  }
}

function unlockUser(userId) {
  if (confirm('Unlock this user account?')) {
    fetch(`/admin/security/users/${userId}/unlock`, {
      method: 'POST',
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert('Failed to unlock user: ' + data.error);
      }
    });
  }
}

function refreshAuditLog() {
  location.reload();
}

function saveSecuritySettings() {
  alert('Security settings would be saved here (not implemented in demo)');
}

function resetSettings() {
  if (confirm('Reset all security settings to defaults?')) {
    location.reload();
  }
}

function scheduleBackup() {
  alert('Backup scheduling interface would open here (not implemented in demo)');
}

function verifyBackup(checksum) {
  alert('Backup verification would run here. Checksum: ' + checksum);
}

function showBackupError(error) {
  alert('Backup Error: ' + error);
}

function viewUserActivity(userId) {
  alert('User activity log would open here (not implemented in demo)');
}

function manageUserRoles(userId) {
  alert('Role management interface would open here (not implemented in demo)');
}
</script>
{% endblock %}