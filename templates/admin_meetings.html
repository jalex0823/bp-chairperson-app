{% extends "base.html" %}
{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Manage Back Porch Meetings</h2>
    <a href="{{ url_for('admin_meeting_new') }}" class="btn btn-success btn-sm">
      + New Meeting
    </a>
  </div>

  <div class="mb-3">
    <div class="card p-3">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <strong>ICS Source:</strong>
          <code>{{ ics_source or 'Not configured' }}</code>
        </div>
        <div>
          {% if ics_source %}
            <a href="{{ url_for('admin_import_ics') }}" class="btn btn-primary btn-sm">Import/Sync from ICS</a>
          {% else %}
            <span class="text-muted">Set SOURCE_MEETINGS_ICS_URL in environment to enable ICS imports.</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="mb-3">
    <div class="card p-3">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <strong>Website Source:</strong>
          <code>{{ web_source or 'Not configured' }}</code>
        </div>
        <div>
          {% if web_source %}
            <a href="{{ url_for('admin_import_web', weeks=12) }}" class="btn btn-primary btn-sm">Import/Sync from Website</a>
          {% else %}
            <span class="text-muted">Set SOURCE_MEETINGS_WEB_URL in environment to enable website scraping imports.</span>
          {% endif %}
        </div>
      </div>
      <small class="text-muted">Parses https meeting page content (times and weekend meetings) and seeds the next 12 weeks.</small>
    </div>
  </div>

  <div class="mb-3">
    <div class="card p-3">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <strong>Static Schedule:</strong>
          <span class="badge {{ 'bg-bp-green' if static_schedule_enabled else 'bg-secondary' }}">{{ 'Enabled' if static_schedule_enabled else 'Disabled' }}</span>
        </div>
        <div>
          {% if static_schedule_enabled %}
            <a href="{{ url_for('admin_seed_static', weeks=12) }}" class="btn btn-outline-success btn-sm">Seed Next 12 Weeks</a>
          {% else %}
            <span class="text-muted">Enable STATIC_SCHEDULE_ENABLED in environment to use built-in schedule.</span>
          {% endif %}
        </div>
      </div>
      <small class="text-muted">Use when no website calendar exists. Seeds Daily 5:30 PM plus Women/Co-ed/Men meetings on weekends.</small>
    </div>
  </div>

  {% if not meetings %}
    <p>No meetings created yet.</p>
  {% else %}
    <table class="table table-striped table-sm align-middle">
      <thead>
        <tr>
          <th>Date</th>
          <th>Meeting</th>
          <th>Chair</th>
          <th>Open?</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for m in meetings %}
          <tr>
            <td>
              {{ m.event_date.strftime('%Y-%m-%d') }}<br>
              <small>{{ m.start_time.strftime('%I:%M %p') }}</small>
            </td>
            <td>
              <strong>{{ m.title }}</strong><br>
              <small class="text-muted">
                {{ m.zoom_link or '' }}
              </small>
            </td>
            <td>
              {% if m.chair_signup %}
                {{ m.chair_signup.display_name_snapshot }}
              {% else %}
                <span class="text-muted">None</span>
              {% endif %}
            </td>
            <td>
              {% if m.is_open %}
                <span class="badge bg-bp-green">Open</span>
              {% else %}
                <span class="badge bg-secondary">Closed</span>
              {% endif %}
            </td>
            <td>
              <a href="{{ url_for('meeting_detail', meeting_id=m.id) }}"
                 class="btn btn-outline-primary btn-sm mb-1">
                View
              </a>
              <a href="{{ url_for('admin_meeting_edit', meeting_id=m.id) }}"
                 class="btn btn-outline-secondary btn-sm mb-1">
                Edit
              </a>
              {% if m.chair_signup %}
                <form method="post"
                      action="{{ url_for('admin_meeting_clear_chair', meeting_id=m.id) }}"
                      style="display:inline;"
                      onsubmit="return confirm('Clear the current chair signup?');">
                  <button type="submit" class="btn btn-outline-warning btn-sm mb-1">
                    Clear Chair
                  </button>
                </form>
              {% endif %}
              <form method="post"
                    action="{{ url_for('admin_meeting_delete', meeting_id=m.id) }}"
                    style="display:inline;"
                    onsubmit="return confirm('Delete this meeting and its chair signup?');">
                <button type="submit" class="btn btn-outline-danger btn-sm mb-1">
                  Delete
                </button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
{% endblock %}
