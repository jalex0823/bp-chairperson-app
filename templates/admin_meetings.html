{% extends "base.html" %}
{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Manage Back Porch Meetings</h2>
    <div>
      <div class="btn-group me-2" role="group">
        <button type="button" class="btn btn-outline-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
          <i class="fas fa-tools"></i> Tools
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="{{ url_for('admin_email_chairs') }}">
            <i class="fas fa-envelope"></i> Email Chairpersons
          </a></li>
          <li><a class="dropdown-item" href="{{ url_for('admin_chair_activity_report', days=30) }}">
            <i class="fas fa-download"></i> Export Activity (30 days)
          </a></li>
          <li><a class="dropdown-item" href="{{ url_for('admin_chair_activity_report', days=90) }}">
            <i class="fas fa-download"></i> Export Activity (90 days)
          </a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="{{ url_for('admin_diagnostics') }}">
            <i class="fas fa-wrench"></i> Diagnostics
          </a></li>
        </ul>
      </div>
      <a href="{{ url_for('admin_security') }}" class="btn btn-warning btn-sm me-2">
        <i class="fas fa-shield-alt"></i> Security
      </a>
      <a href="{{ url_for('admin_analytics') }}" class="btn btn-info btn-sm me-2">
        <i class="fas fa-chart-bar"></i> Analytics
      </a>
      <a href="{{ url_for('admin_meeting_new') }}" class="btn btn-success btn-sm">
        <i class="fas fa-plus"></i> New Meeting
      </a>
    </div>
  </div>

  <div class="mb-3">
    <div class="card p-3">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <strong>ICS Source:</strong>
          <code>{{ ics_source or 'Not configured' }}</code>
        </div>
        <div>
          {% if ics_source %}
            <a href="{{ url_for('admin_import_ics') }}" class="btn btn-primary btn-sm">Import/Sync from ICS</a>
          {% else %}
            <span class="text-muted">Set SOURCE_MEETINGS_ICS_URL in environment to enable ICS imports.</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="mb-3">
    <div class="card p-3">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <strong>Website Source:</strong>
          <code>{{ web_source or 'Not configured' }}</code>
        </div>
        <div>
          {% if web_source %}
            <a href="{{ url_for('admin_import_web', weeks=12) }}" class="btn btn-primary btn-sm">Import/Sync from Website</a>
          {% else %}
            <span class="text-muted">Set SOURCE_MEETINGS_WEB_URL in environment to enable website scraping imports.</span>
          {% endif %}
        </div>
      </div>
      <small class="text-muted">Parses https meeting page content (times and weekend meetings) and seeds the next 12 weeks.</small>
    </div>
  </div>

  <div class="mb-3">
    <div class="card p-3">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <strong>Static Schedule:</strong>
          <span class="badge {{ 'bg-bp-green' if static_schedule_enabled else 'bg-secondary' }}">{{ 'Enabled' if static_schedule_enabled else 'Disabled' }}</span>
        </div>
        <div>
          {% if static_schedule_enabled %}
            <a href="{{ url_for('admin_seed_static', weeks=12) }}" class="btn btn-outline-success btn-sm">Seed Next 12 Weeks</a>
          {% else %}
            <span class="text-muted">Enable STATIC_SCHEDULE_ENABLED in environment to use built-in schedule.</span>
          {% endif %}
        </div>
      </div>
      <small class="text-muted">Use when no website calendar exists. Seeds Daily 5:30 PM plus Women/Co-ed/Men meetings on weekends.</small>
    </div>
  </div>

  <!-- Email Reminder Management -->
  <div class="card mb-4">
    <div class="card-header bg-warning text-dark">
      <h6 class="mb-0"><i class="fas fa-envelope"></i> Email Reminder System</h6>
    </div>
    <div class="card-body">
      <div class="row g-2 align-items-center">
        <div class="col-md-4">
          <small class="text-muted d-block">Automated reminders for chairpersons</small>
          <strong>24h & 1h before meetings</strong>
        </div>
        <div class="col-md-8 text-end">
          <form method="POST" action="{{ url_for('admin_send_reminders') }}" style="display: inline;">
            <button type="submit" class="btn btn-warning btn-sm me-2" 
                    onclick="return confirm('Send reminder emails for upcoming meetings?')">
              <i class="fas fa-paper-plane"></i> Send Due Reminders
            </button>
          </form>
          
          <form method="POST" action="{{ url_for('admin_send_confirmations') }}" style="display: inline;">
            <button type="submit" class="btn btn-outline-warning btn-sm" 
                    onclick="return confirm('Send confirmation emails for recent signups?')">
              <i class="fas fa-check-circle"></i> Send Confirmations
            </button>
          </form>
        </div>
      </div>
      <small class="text-muted">Note: Reminders are sent automatically. Use manual sending for testing or catch-up.</small>
    </div>
  </div>

  <!-- Search and Filter Section -->
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h6 class="mb-0"><i class="fas fa-search"></i> Search & Filter Meetings</h6>
    </div>
    <div class="card-body">
      <form method="GET" class="row g-3">
        <div class="col-md-4">
          <label for="search" class="form-label">Search</label>
          <input type="text" class="form-control" id="search" name="search" 
                 value="{{ current_filters.search }}" 
                 placeholder="Search title or description...">
        </div>
        
        <div class="col-md-2">
          <label for="meeting_type" class="form-label">Type</label>
          <select class="form-select" id="meeting_type" name="meeting_type">
            <option value="">All Types</option>
            {% for mt in meeting_types %}
              <option value="{{ mt }}" {% if current_filters.meeting_type == mt %}selected{% endif %}>{{ mt }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div class="col-md-2">
          <label for="date_from" class="form-label">From Date</label>
          <input type="date" class="form-control" id="date_from" name="date_from" 
                 value="{{ current_filters.date_from }}">
        </div>
        
        <div class="col-md-2">
          <label for="date_to" class="form-label">To Date</label>
          <input type="date" class="form-control" id="date_to" name="date_to" 
                 value="{{ current_filters.date_to }}">
        </div>
        
        <div class="col-md-2">
          <label for="chair_status" class="form-label">Chair Status</label>
          <select class="form-select" id="chair_status" name="chair_status">
            <option value="">All</option>
            <option value="has_chair" {% if current_filters.chair_status == 'has_chair' %}selected{% endif %}>Has Chair</option>
            <option value="no_chair" {% if current_filters.chair_status == 'no_chair' %}selected{% endif %}>Needs Chair</option>
          </select>
        </div>
        
        <div class="col-12">
          <button type="submit" class="btn btn-primary btn-sm me-2">
            <i class="fas fa-search"></i> Apply Filters
          </button>
          <a href="{{ url_for('admin_meetings') }}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-times"></i> Clear All
          </a>
          <span class="text-muted ms-3">{{ meetings|length }} meeting(s) found</span>
        </div>
      </form>
    </div>
  </div>

  {% if not meetings %}
    {% if current_filters.search or current_filters.meeting_type or current_filters.date_from or current_filters.date_to or current_filters.chair_status %}
      <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> No meetings match your search criteria. Try adjusting your filters.
      </div>
    {% else %}
      <p>No meetings created yet.</p>
    {% endif %}
  {% else %}
    <table class="table table-striped table-sm align-middle">
      <thead>
        <tr>
          <th>Date</th>
          <th>Meeting</th>
          <th>Type</th>
          <th>Chair</th>
          <th>Open?</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for m in meetings %}
          <tr data-meeting-id="{{ m.id }}" 
              data-meeting-date="{{ m.event_date.isoformat() }}" 
              data-meeting-start-time="{{ m.start_time.strftime('%H:%M') if m.start_time }}" 
              data-meeting-end-time="{{ m.end_time.strftime('%H:%M') if m.end_time }}"
              data-chair-id="{{ m.chair_signup.user_id if m.chair_signup else '' }}"
              data-meeting-type="{{ m.meeting_type }}">
            <td>
              {{ m.event_date.strftime('%Y-%m-%d') }}<br>
              <small>{{ m.start_time.strftime('%I:%M %p') }}</small>
            </td>
            <td>
              <strong>{{ m.title }}</strong><br>
              <small class="text-muted">
                {{ m.zoom_link or '' }}
              </small>
            </td>
            <td>
              <span class="badge {{ m.type_badge_class }}">
                <i class="{{ m.type_icon }}"></i> {{ m.meeting_type }}
              </span>
            </td>
            <td>
              {% if m.chair_signup %}
                {{ m.chair_signup.display_name_snapshot }}
              {% else %}
                <span class="text-muted">None</span>
              {% endif %}
            </td>
            <td>
              {% if m.is_open %}
                <span class="badge bg-bp-green">Open</span>
              {% else %}
                <span class="badge bg-secondary">Closed</span>
              {% endif %}
            </td>
            <td>
              <a href="{{ url_for('meeting_detail', meeting_id=m.id) }}"
                 class="btn btn-outline-primary btn-sm mb-1">
                View
              </a>
              <a href="{{ url_for('admin_meeting_edit', meeting_id=m.id) }}"
                 class="btn btn-outline-secondary btn-sm mb-1">
                Edit
              </a>
              {% if not m.chair_signup %}
                <button type="button" class="btn btn-outline-success btn-sm mb-1" 
                        data-bs-toggle="modal" data-bs-target="#assignChairModal{{ m.id }}">
                  <i class="fas fa-user-plus"></i> Assign
                </button>
              {% endif %}
              {% if m.chair_signup %}
                <form method="post"
                      action="{{ url_for('admin_meeting_clear_chair', meeting_id=m.id) }}"
                      style="display:inline;"
                      onsubmit="return confirm('Clear the current chair signup?');">
                  <button type="submit" class="btn btn-outline-warning btn-sm mb-1">
                    Clear Chair
                  </button>
                </form>
                <form method="post"
                      action="{{ url_for('admin_test_reminder', meeting_id=m.id) }}"
                      style="display:inline;"
                      onsubmit="return confirm('Send test reminder to {{ m.chair_signup.user.display_name }}?');">
                  <button type="submit" class="btn btn-outline-info btn-sm mb-1" title="Send test reminder">
                    <i class="fas fa-paper-plane"></i>
                  </button>
                </form>
              {% endif %}
              <form method="post"
                    action="{{ url_for('admin_meeting_delete', meeting_id=m.id) }}"
                    style="display:inline;"
                    onsubmit="return confirm('Delete this meeting and its chair signup?');">
                <button type="submit" class="btn btn-outline-danger btn-sm mb-1">
                  Delete
                </button>
              </form>
            </td>
          </tr>
          
          <!-- Assign Chair Modal for meeting {{ m.id }} -->
          {% if not m.chair_signup %}
          <tr style="display:none;">
            <td colspan="6">
              <div class="modal fade" id="assignChairModal{{ m.id }}" tabindex="-1">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Assign Chair to: {{ m.title }}</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form method="POST" action="{{ url_for('admin_assign_chair', meeting_id=m.id) }}">
                      <div class="modal-body">
                        <div class="mb-3">
                          <label class="form-label">Select Chairperson</label>
                          <select name="user_id" class="form-select" required>
                            <option value="">-- Choose a chairperson --</option>
                            {% for user in all_users %}
                            <option value="{{ user.id }}">{{ user.display_name }} ({{ user.email }})</option>
                            {% endfor %}
                          </select>
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Notes (optional)</label>
                          <textarea name="notes" class="form-control" rows="2" 
                                    placeholder="Any special instructions or notes"></textarea>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Assign Chair</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </td>
          </tr>
          {% endif %}
        {% endfor %}
      </tbody>
    </table>
    
    <!-- Pagination -->
    {% if pagination and pagination.pages > 1 %}
    <div class="d-flex justify-content-between align-items-center mt-4">
      <div class="text-muted">
        Showing {{ ((pagination.page - 1) * pagination.per_page) + 1 }} to 
        {{ pagination.page * pagination.per_page if pagination.page * pagination.per_page <= pagination.total else pagination.total }} 
        of {{ pagination.total }} meetings
      </div>
      
      <nav aria-label="Meeting pagination">
        <ul class="pagination pagination-sm mb-0">
          <!-- Previous page -->
          <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
            <a class="page-link" href="{% if pagination.has_prev %}{{ url_for('admin_meetings', page=pagination.prev_num, search=current_filters.search, meeting_type=current_filters.meeting_type, date_from=current_filters.date_from, date_to=current_filters.date_to, chair_status=current_filters.chair_status, per_page=current_filters.per_page) }}{% else %}#{% endif %}">
              <i class="fas fa-chevron-left"></i> Previous
            </a>
          </li>
          
          <!-- Page numbers -->
          {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
            {% if page_num %}
              {% if page_num != pagination.page %}
                <li class="page-item">
                  <a class="page-link" href="{{ url_for('admin_meetings', page=page_num, search=current_filters.search, meeting_type=current_filters.meeting_type, date_from=current_filters.date_from, date_to=current_filters.date_to, chair_status=current_filters.chair_status, per_page=current_filters.per_page) }}">{{ page_num }}</a>
                </li>
              {% else %}
                <li class="page-item active">
                  <span class="page-link">{{ page_num }}</span>
                </li>
              {% endif %}
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">â€¦</span>
              </li>
            {% endif %}
          {% endfor %}
          
          <!-- Next page -->
          <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
            <a class="page-link" href="{% if pagination.has_next %}{{ url_for('admin_meetings', page=pagination.next_num, search=current_filters.search, meeting_type=current_filters.meeting_type, date_from=current_filters.date_from, date_to=current_filters.date_to, chair_status=current_filters.chair_status, per_page=current_filters.per_page) }}{% else %}#{% endif %}">
              Next <i class="fas fa-chevron-right"></i>
            </a>
          </li>
        </ul>
      </nav>
      
      <!-- Page size selector -->
      <div class="d-flex align-items-center">
        <label for="perPageSelect" class="form-label me-2 mb-0 small">Per page:</label>
        <select id="perPageSelect" class="form-select form-select-sm" style="width: auto;" onchange="changePageSize(this.value)">
          <option value="10" {% if current_filters.per_page == 10 %}selected{% endif %}>10</option>
          <option value="20" {% if current_filters.per_page == 20 %}selected{% endif %}>20</option>
          <option value="50" {% if current_filters.per_page == 50 %}selected{% endif %}>50</option>
          <option value="100" {% if current_filters.per_page == 100 %}selected{% endif %}>100</option>
        </select>
      </div>
    </div>
    {% endif %}
  {% endif %}

<!-- Enhanced search and filtering -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-submit form on filter changes (except search)
    const filterSelects = document.querySelectorAll('#meeting_type, #chair_status');
    filterSelects.forEach(select => {
        select.addEventListener('change', function() {
            this.form.submit();
        });
    });
    
    // Auto-submit on date changes
    const dateInputs = document.querySelectorAll('#date_from, #date_to');
    dateInputs.forEach(input => {
        input.addEventListener('change', function() {
            this.form.submit();
        });
    });
    
    // Debounced search
    const searchInput = document.querySelector('#search');
    let searchTimeout;
    
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                if (this.value.length >= 2 || this.value.length === 0) {
                    this.form.submit();
                }
            }, 750);
        });
        
        // Submit on Enter
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                this.form.submit();
            }
        });
    }
    
    // Date range validation
    const dateFromInput = document.querySelector('#date_from');
    const dateToInput = document.querySelector('#date_to');
    
    if (dateFromInput && dateToInput) {
        dateFromInput.addEventListener('change', function() {
            if (dateToInput.value && this.value > dateToInput.value) {
                alert('Start date cannot be after end date');
                this.value = '';
                return;
            }
        });
        
        dateToInput.addEventListener('change', function() {
            if (dateFromInput.value && this.value < dateFromInput.value) {
                alert('End date cannot be before start date');
                this.value = '';
                return;
            }
        });
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl+F to focus search
        if (e.ctrlKey && e.key === 'f' && searchInput) {
            e.preventDefault();
            searchInput.focus();
            searchInput.select();
        }
        
        // Esc to clear search
        if (e.key === 'Escape' && searchInput && searchInput === document.activeElement) {
            searchInput.value = '';
            searchInput.form.submit();
        }
    });
    
    // Add loading state when form is submitting
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function() {
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';
                submitBtn.disabled = true;
            }
        });
    }
});

// Function to change page size
function changePageSize(newSize) {
    const url = new URL(window.location);
    url.searchParams.set('per_page', newSize);
    url.searchParams.set('page', '1'); // Reset to first page
    window.location.href = url.toString();
}
</script>

<!-- Meeting Enhancements -->
<script src="{{ url_for('static', filename='js/meeting-enhancements.js') }}?v={{ asset_version }}"></script>

{% endblock %}
