{% extends "base.html" %}
{% block content %}
  <div class="container py-4">
    <div class="row justify-content-center">
      <div class="col-12 col-md-10 col-lg-8 col-xl-7">
        <h2 class="mb-3 text-center">Register as a Sponsor</h2>

        {% if access_codes_configured %}
          <!-- Avoid flashing the key box after it's already been accepted -->
          <script>
            (function() {
              try {
                const unlocked = localStorage.getItem('bp_sponsor_unlocked') === '1';
                const key = localStorage.getItem('bp_sponsor_access_code');
                if (unlocked && key) {
                  document.documentElement.classList.add('bp-sponsor-unlocked');
                }
              } catch (e) {}
            })();
          </script>
          <style>
            .bp-sponsor-unlocked #sponsorKeySection { display: none !important; }
          </style>
        {% endif %}

        <div class="alert alert-info">
          <strong>Note:</strong> Sponsor registration requires a <strong>BP Sponsor Key</strong>. If you don’t have one, request it below and we’ll send a key after verification.
        </div>

        <div class="d-flex flex-wrap gap-2 mb-3">
          <a href="mailto:backporchmeetings@outlook.com?subject=Request%20BP%20Sponsor%20Key&body=Hello,%0D%0A%0D%0AI would like to request a BP Sponsor Key to register as a sponsor.%0D%0A%0D%0AThank you!"
             class="btn btn-gold">
            Request BP Sponsor Key
          </a>
          <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">Back to Home</a>
        </div>

        <div class="card shadow-sm">
          <div class="card-body p-4">
            <form id="sponsorRegisterForm" method="post" novalidate enctype="multipart/form-data">
              {{ form.hidden_tag() }}

              {% if form.errors %}
                <div class="alert alert-danger">
                  <strong>Please fix the following:</strong>
                  <ul class="mb-0">
                    {% for field_name, errors in form.errors.items() %}
                      {% for err in errors %}
                        <li><strong>{{ field_name|replace('_',' ')|title }}:</strong> {{ err }}</li>
                      {% endfor %}
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}

              {% if access_codes_configured %}
              <!-- Sponsor Key Section -->
              <div id="sponsorKeySection" class="mb-4 p-3 border rounded" style="background-color: var(--bp-gold-light); border-color: var(--bp-gold) !important;">
                <div class="d-flex align-items-center mb-2">
                  <i class="fas fa-key text-warning me-2" style="font-size: 1.5rem;"></i>
                  <h5 class="mb-0">BP Sponsor Key Required</h5>
                </div>

                <label for="sponsor_access_code" class="form-label fw-bold">Enter Your BP Sponsor Key:</label>
                <div class="input-group mb-2">
                  {{ form.access_code(class='form-control', id='sponsor_access_code', placeholder='Enter BP Sponsor Key', autocomplete='off') }}
                  <button type="button" id="sponsorUnlockSubmit" class="btn btn-primary">
                    <i class="fas fa-unlock"></i> Submit
                  </button>
                  <button type="button" id="sponsorUnlockClear" class="btn btn-outline-secondary">
                    <i class="fas fa-times"></i> Clear
                  </button>
                </div>

                <div class="card mt-3" style="border: 2px solid var(--bp-green); background-color: var(--bp-green);">
                  <div class="card-body p-3">
                    <h6 class="card-title mb-2" style="color: white;">
                      <i class="fas fa-envelope"></i> Need a BP Sponsor Key?
                    </h6>
                    <p class="card-text small mb-2" style="color: white;">
                      Request a BP-Sponsor-Key from Back Porch (verification required).
                    </p>
                    <a href="mailto:backporchmeetings@outlook.com?subject=Request%20BP%20Sponsor%20Key&body=Hello,%0D%0A%0D%0AI would like to request a BP Sponsor Key to register as a sponsor.%0D%0A%0D%0AThank you!"
                       class="btn btn-gold btn-sm w-100">
                      <i class="fas fa-paper-plane"></i> Request a BP Sponsor Key
                    </a>
                  </div>
                </div>

                <div id="sponsorUnlockStatus" class="mt-3" style="display: none;">
                  <div class="alert alert-success mb-0" role="alert">
                    <i class="fas fa-check-circle"></i> <strong>Form Unlocked!</strong> You may now complete sponsor registration below.
                  </div>
                </div>
              </div>
              {% endif %}

              <fieldset id="sponsorRegFields" {% if access_codes_configured %}disabled{% endif %}>
                <div class="mb-3">
                  {{ form.display_name.label(class="form-label") }}
                  {{ form.display_name(class="form-control", id="sponsor_display_name", placeholder="Example: Jeff A.") }}
                  <div id="sponsorPrefillHint" class="form-text" style="display:none;"></div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    {{ form.email.label(class="form-label") }}
                    {{ form.email(class="form-control", id="sponsor_email", type="email", autocomplete="username", placeholder="name@example.com") }}
                  </div>
                  <div class="col-md-6 mb-3">
                    {{ form.password.label(class="form-label") }}
                    {{ form.password(class="form-control", type="password", autocomplete="new-password", placeholder="Create a password") }}
                  </div>
                </div>

                <div class="mb-3">
                  {{ form.sobriety_date.label(class="form-label") }}
                  {{ form.sobriety_date(class="form-control", type="date") }}
                  <div class="form-text">Calendar format: YYYY-MM-DD</div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    {{ form.current_sponsees.label(class="form-label") }}
                    {{ form.current_sponsees(class="form-control", type="number", min="0") }}
                  </div>
                  <div class="col-md-6 mb-3">
                    {{ form.max_sponsees.label(class="form-label") }}
                    {{ form.max_sponsees(class="form-control", type="number", min="0") }}
                  </div>
                </div>

                <hr>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    {{ form.phone.label(class="form-label") }}
                    {{ form.phone(class="form-control phone-us", id="sponsor_phone", placeholder="(000) 000-0000") }}
                  </div>
                </div>

                <div class="mb-3">
                  {{ form.bio.label(class="form-label") }}
                  {{ form.bio(class="form-control", rows="5", placeholder="Tell a little about yourself, what you’re like as a sponsor, availability, approach, etc.") }}
                </div>

                <div class="mb-3">
                  {{ form.profile_image.label(class="form-label") }}
                  {{ form.profile_image(class="form-control", accept="image/*") }}
                  <div class="form-text">Optional. Photo shown next to your bio in the Sponsor Directory.</div>
                </div>

                <div class="d-flex gap-2">
                  {{ form.submit(class="btn btn-primary") }}
                  <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">Back to Home</a>
                </div>
              </fieldset>
            </form>
          </div>
        </div>

        <p class="mt-3 small">
          Already registered as a sponsor?
          <a href="{{ url_for('sponsor_login') }}">Sponsor Log In</a>
        </p>

        <!-- Unlock feedback modal -->
        <div class="modal fade" id="sponsorUnlockModal" tabindex="-1" aria-labelledby="sponsorUnlockModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header" id="sponsorUnlockModalHeader">
                <h5 class="modal-title" id="sponsorUnlockModalLabel">BP Sponsor Key</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body" id="sponsorUnlockModalBody">
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
              </div>
            </div>
          </div>
        </div>

        <style>
          /* Sponsor unlock celebration (graffiti + confetti) */
          .sponsor-unlock-celebration {
            position: fixed;
            inset: 0;
            z-index: 2000; /* above Bootstrap modal backdrop (1050) */
            pointer-events: none;
            display: none;
          }
          .sponsor-unlock-celebration.active { display: block; }
          .sponsor-unlock-celebration .overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.35);
            backdrop-filter: blur(1px);
          }
          .sponsor-unlock-celebration .graffiti {
            position: absolute;
            left: 50%;
            top: 18%;
            transform: translateX(-50%) rotate(-4deg);
            font-weight: 900;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            font-size: clamp(2rem, 6vw, 4rem);
            color: #ffd54a;
            text-shadow:
              -3px -3px 0 #0f6f75,
              3px -3px 0 #0f6f75,
              -3px 3px 0 #0f6f75,
              3px 3px 0 #0f6f75,
              0 10px 24px rgba(0,0,0,0.35);
            animation: sponsorGraffitiPop 900ms ease-out both;
            border-radius: 16px;
            padding: 8px 18px;
            background: rgba(255, 255, 255, 0.08);
          }
          .sponsor-unlock-celebration .graffiti small {
            display: block;
            font-size: 0.45em;
            font-weight: 700;
            opacity: 0.95;
            margin-top: 6px;
            letter-spacing: 0.02em;
          }
          @keyframes sponsorGraffitiPop {
            0%   { transform: translateX(-50%) scale(0.75) rotate(-10deg); opacity: 0; }
            60%  { transform: translateX(-50%) scale(1.06) rotate(-4deg); opacity: 1; }
            100% { transform: translateX(-50%) scale(1.0) rotate(-4deg); opacity: 1; }
          }
          .sponsor-confetti {
            position: absolute;
            inset: 0;
            overflow: hidden;
          }
          .sponsor-confetti .c {
            position: absolute;
            width: 10px;
            height: 16px;
            border-radius: 2px;
            opacity: 0.95;
            top: -20px;
            animation: sponsorConfettiFall linear forwards;
          }
          @keyframes sponsorConfettiFall {
            to { transform: translateY(110vh) rotate(520deg); }
          }
        </style>

        <div id="sponsorUnlockCelebration" class="sponsor-unlock-celebration" aria-hidden="true">
          <div class="overlay"></div>
          <div class="sponsor-confetti" id="sponsorConfetti"></div>
          <div class="graffiti">
            Unlocked!
            <small>Welcome to service</small>
          </div>
        </div>

        <script>
          document.addEventListener('DOMContentLoaded', function() {
            const accessConfigured = {{ 'true' if access_codes_configured else 'false' }};
            const accessInput = document.getElementById('sponsor_access_code');
            const keySection = document.getElementById('sponsorKeySection');
            const regFields = document.getElementById('sponsorRegFields');
            const submitBtn = document.querySelector('#sponsorRegisterForm button[type="submit"], #sponsorRegisterForm input[type="submit"]');
            const unlockStatus = document.getElementById('sponsorUnlockStatus');
            const emailInput = document.getElementById('sponsor_email');
            const nameInput = document.getElementById('sponsor_display_name');
            const prefillHint = document.getElementById('sponsorPrefillHint');
            let failedAttempts = 0;
            let unlockDisabledUntil = 0;
            let prefillTimer = null;

            const modalEl = document.getElementById('sponsorUnlockModal');
            const modalHeader = document.getElementById('sponsorUnlockModalHeader');
            const modalBody = document.getElementById('sponsorUnlockModalBody');
            const sponsorUnlockModal = (modalEl && window.bootstrap) ? new bootstrap.Modal(modalEl) : null;

            function showModal(kind, message) {
              if (!modalHeader || !modalBody || !sponsorUnlockModal) return;
              // kind: 'success' | 'danger' | 'warning' | 'info'
              modalHeader.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info', 'text-white', 'text-dark');
              if (kind === 'success' || kind === 'danger' || kind === 'info') {
                modalHeader.classList.add('text-white');
              } else {
                modalHeader.classList.add('text-dark');
              }
              if (kind === 'success') modalHeader.classList.add('bg-success');
              if (kind === 'danger') modalHeader.classList.add('bg-danger');
              if (kind === 'warning') modalHeader.classList.add('bg-warning');
              if (kind === 'info') modalHeader.classList.add('bg-info');
              modalBody.textContent = message;
              sponsorUnlockModal.show();
            }

            function triggerUnlockCelebration() {
              const root = document.getElementById('sponsorUnlockCelebration');
              const confettiWrap = document.getElementById('sponsorConfetti');
              if (!root || !confettiWrap) return;

              confettiWrap.innerHTML = '';
              const colors = ['#ffd54a', '#0f6f75', '#28a745', '#007bff', '#dc3545', '#ffa500'];
              const pieces = 60;
              for (let i = 0; i < pieces; i++) {
                const d = document.createElement('div');
                d.className = 'c';
                d.style.left = `${Math.random() * 100}%`;
                d.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                d.style.animationDuration = `${2200 + Math.random() * 1400}ms`;
                d.style.animationDelay = `${Math.random() * 250}ms`;
                d.style.transform = `translateY(0) rotate(${Math.random() * 180}deg)`;
                confettiWrap.appendChild(d);
              }

              root.classList.add('active');
              setTimeout(() => root.classList.remove('active'), 2500);
            }

            function setLockedState(locked) {
              if (!regFields) return;
              // regFields is a FIELDSET. If it remains disabled, children cannot be used
              // even if we toggle each input's disabled property.
              if (typeof regFields.disabled !== 'undefined') {
                regFields.disabled = locked;
              }
              for (const el of regFields.querySelectorAll('input, select, textarea')) {
                el.disabled = locked;
              }
              if (submitBtn) submitBtn.disabled = locked;
            }

            function setKeySectionVisible(visible) {
              if (!keySection) return;
              if (visible) {
                keySection.classList.remove('d-none');
                keySection.removeAttribute('aria-hidden');
                document.documentElement.classList.remove('bp-sponsor-unlocked');
              } else {
                keySection.classList.add('d-none');
                keySection.setAttribute('aria-hidden', 'true');
                document.documentElement.classList.add('bp-sponsor-unlocked');
              }
            }

            function clearUnlock() {
              localStorage.removeItem('bp_sponsor_access_code');
              localStorage.removeItem('bp_sponsor_unlocked');
              if (accessInput) accessInput.value = '';
              setLockedState(true);
              if (prefillHint) prefillHint.style.display = 'none';
              if (accessInput) {
                accessInput.classList.remove('is-valid');
                accessInput.classList.remove('is-invalid');
              }
              if (unlockStatus) unlockStatus.style.display = 'none';
              setKeySectionVisible(true);
              if (accessInput) accessInput.focus();
            }

            async function tryUnlock(opts) {
              const silent = !!(opts && opts.silent);
              const now = Date.now();
              if (unlockDisabledUntil && now < unlockDisabledUntil) {
                const secs = Math.ceil((unlockDisabledUntil - now) / 1000);
                if (!silent) showModal('warning', `Please wait ${secs}s before trying again.`);
                return;
              }
              const key = (accessInput && accessInput.value ? accessInput.value.trim() : '');
              if (!key) {
                if (!silent) showModal('warning', 'Please enter your BP Sponsor Key.');
                return;
              }
              try {
                const resp = await fetch('/api/sponsor/validate-key', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ key })
                });
                const data = await resp.json();
                if (data && data.ok) {
                  localStorage.setItem('bp_sponsor_access_code', key);
                  localStorage.setItem('bp_sponsor_unlocked', '1');
                  setLockedState(false);
                  // Hide the key entry UI after a successful unlock.
                  setKeySectionVisible(false);
                  if (accessInput) {
                    accessInput.classList.remove('is-invalid');
                    accessInput.classList.add('is-valid');
                  }
                  // Only show the "Key accepted" announcement the first time the user unlocks manually.
                  if (!silent) {
                    if (unlockStatus) unlockStatus.style.display = 'block';
                    showModal('success', 'Key accepted. Sponsor registration form unlocked.');
                    triggerUnlockCelebration();
                  } else {
                    // On auto-unlock (page reload / after validation errors), keep it quiet.
                    if (unlockStatus) unlockStatus.style.display = 'none';
                  }
                  // After unlock, attempt to prefill name from chairperson account (if email matches)
                  schedulePrefill();
                } else {
                  failedAttempts++;
                  if (accessInput) {
                    accessInput.classList.remove('is-valid');
                    accessInput.classList.add('is-invalid');
                  }
                  if (data && data.reason === 'not_configured') {
                    if (!silent) showModal('warning', 'Sponsor registration is currently locked (no keys configured). Please request a BP Sponsor Key and try again later.');
                  } else {
                    if (!silent) showModal('danger', 'Invalid BP Sponsor Key. Please check the key (copy/paste) or request a new one.');
                  }
                  // If auto-unlock fails, clear stored key and show the key section again.
                  if (silent) clearUnlock();
                  if (failedAttempts >= 5) {
                    unlockDisabledUntil = Date.now() + (30 * 1000);
                  }
                }
              } catch (e) {
                failedAttempts++;
                if (accessInput) {
                  accessInput.classList.remove('is-valid');
                  accessInput.classList.add('is-invalid');
                }
                if (!silent) showModal('danger', 'Could not validate the key right now. Please try again.');
                if (silent) clearUnlock();
                if (failedAttempts >= 5) {
                  unlockDisabledUntil = Date.now() + (30 * 1000);
                }
              }
            }

            async function prefillFromChair() {
              if (!emailInput || !nameInput) return;
              const key = localStorage.getItem('bp_sponsor_access_code') || (accessInput && accessInput.value ? accessInput.value.trim() : '');
              if (!key) return;
              const email = (emailInput.value || '').trim();
              const name = (nameInput.value || '').trim();
              if (!email || email.length < 5) return;
              // Only prefill if name is currently empty (don't overwrite user's edits)
              if (name) return;

              try {
                const resp = await fetch('/api/sponsor/prefill', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ key, email })
                });
                const data = await resp.json();
                if (data && data.ok && data.found && data.display_name) {
                  nameInput.value = data.display_name;
                  if (prefillHint) {
                    prefillHint.textContent = 'We found a chairperson account for this email and pre-filled your name. You can edit it.';
                    prefillHint.style.display = 'block';
                  }
                } else {
                  if (prefillHint) prefillHint.style.display = 'none';
                }
              } catch (e) {
                // ignore prefill failures
              }
            }

            function schedulePrefill() {
              if (!accessConfigured) return;
              if (!emailInput) return;
              if (prefillTimer) clearTimeout(prefillTimer);
              prefillTimer = setTimeout(prefillFromChair, 400);
            }

            if (accessConfigured) {
              setLockedState(true);
              setKeySectionVisible(true);
              const unlockBtn = document.getElementById('sponsorUnlockSubmit');
              const clearBtn = document.getElementById('sponsorUnlockClear');
              if (unlockBtn) unlockBtn.addEventListener('click', tryUnlock);
              if (emailInput) {
                emailInput.addEventListener('blur', schedulePrefill);
                emailInput.addEventListener('input', schedulePrefill);
              }
              if (clearBtn) {
                clearBtn.addEventListener('click', clearUnlock);
              }

              const saved = localStorage.getItem('bp_sponsor_access_code');
              const savedUnlocked = localStorage.getItem('bp_sponsor_unlocked') === '1';
              if (savedUnlocked && saved && accessInput) {
                accessInput.value = saved;
                // Hide key section immediately (no flash) and optimistically unlock fields,
                // then validate silently. If validation fails, clearUnlock() will re-lock/show.
                setKeySectionVisible(false);
                setLockedState(false);
                // Auto-unlock silently so users don't see the success announcement again on reload.
                tryUnlock({ silent: true });
              }
            } else {
              setLockedState(false);
            }
          });
        </script>
      </div>
    </div>
  </div>
{% endblock %}

