{% extends "base.html" %}
{% block content %}
  <div class="container py-4">
    <div class="row justify-content-center">
      <div class="col-12 col-md-10 col-lg-8 col-xl-7">
        <h2 class="mb-3 text-center">Register as a Sponsor</h2>

        <div class="alert alert-info">
          <strong>Note:</strong> Sponsor registration requires a <strong>BP Sponsor Key</strong>. If you don’t have one, request it and we’ll send a key after verification.
        </div>

        <div class="card shadow-sm">
          <div class="card-body p-4">
            <form id="sponsorRegisterForm" method="post" novalidate>
              {{ form.hidden_tag() }}

              {% if access_codes_configured %}
              <!-- Sponsor Key Section -->
              <div class="mb-4 p-3 border rounded" style="background-color: var(--bp-gold-light); border-color: var(--bp-gold) !important;">
                <div class="d-flex align-items-center mb-2">
                  <i class="fas fa-key text-warning me-2" style="font-size: 1.5rem;"></i>
                  <h5 class="mb-0">BP Sponsor Key Required</h5>
                </div>

                <label for="sponsor_access_code" class="form-label fw-bold">Enter Your BP Sponsor Key:</label>
                <div class="input-group mb-2">
                  {{ form.access_code(class='form-control', id='sponsor_access_code', placeholder='Enter BP Sponsor Key', autocomplete='off') }}
                  <button type="button" id="sponsorUnlockSubmit" class="btn btn-primary">
                    <i class="fas fa-unlock"></i> Submit
                  </button>
                  <button type="button" id="sponsorUnlockClear" class="btn btn-outline-secondary">
                    <i class="fas fa-times"></i> Clear
                  </button>
                </div>

                <div class="card mt-3" style="border: 2px solid var(--bp-green); background-color: var(--bp-green);">
                  <div class="card-body p-3">
                    <h6 class="card-title mb-2" style="color: white;">
                      <i class="fas fa-envelope"></i> Need a BP Sponsor Key?
                    </h6>
                    <p class="card-text small mb-2" style="color: white;">
                      Request a BP-Sponsor-Key from Back Porch (verification required).
                    </p>
                    <a href="mailto:backporchmeetings@outlook.com?subject=Request%20BP%20Sponsor%20Key&body=Hello,%0D%0A%0D%0AI would like to request a BP Sponsor Key to register as a sponsor.%0D%0A%0D%0AThank you!"
                       class="btn btn-gold btn-sm w-100">
                      <i class="fas fa-paper-plane"></i> Request a BP Sponsor Key
                    </a>
                  </div>
                </div>

                <div id="sponsorUnlockStatus" class="mt-3" style="display: none;">
                  <div class="alert alert-success mb-0" role="alert">
                    <i class="fas fa-check-circle"></i> <strong>Form Unlocked!</strong> You may now complete sponsor registration below.
                  </div>
                </div>
              </div>
              {% endif %}

              <fieldset id="sponsorRegFields">
                <div class="mb-3">
                  {{ form.display_name.label(class="form-label") }}
                  {{ form.display_name(class="form-control", placeholder="Example: Jeff A.") }}
                </div>

                <div class="mb-3">
                  {{ form.sobriety_date.label(class="form-label") }}
                  {{ form.sobriety_date(class="form-control", type="date") }}
                  <div class="form-text">Calendar format: YYYY-MM-DD</div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    {{ form.current_sponsees.label(class="form-label") }}
                    {{ form.current_sponsees(class="form-control", type="number", min="0") }}
                  </div>
                  <div class="col-md-6 mb-3">
                    {{ form.max_sponsees.label(class="form-label") }}
                    {{ form.max_sponsees(class="form-control", type="number", min="0") }}
                  </div>
                </div>

                <hr>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    {{ form.email.label(class="form-label") }}
                    {{ form.email(class="form-control", placeholder="name@example.com") }}
                  </div>
                  <div class="col-md-6 mb-3">
                    {{ form.phone.label(class="form-label") }}
                    {{ form.phone(class="form-control", placeholder="Optional") }}
                  </div>
                </div>

                <div class="mb-3">
                  {{ form.notes.label(class="form-label") }}
                  {{ form.notes(class="form-control", rows="4", placeholder="Optional: sponsorship preferences, availability, etc.") }}
                </div>

                <div class="d-flex gap-2">
                  {{ form.submit(class="btn btn-primary") }}
                  <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">Back to Home</a>
                </div>
              </fieldset>
            </form>
          </div>
        </div>

        <script>
          document.addEventListener('DOMContentLoaded', function() {
            const accessConfigured = {{ 'true' if access_codes_configured else 'false' }};
            const accessInput = document.getElementById('sponsor_access_code');
            const regFields = document.getElementById('sponsorRegFields');
            const submitBtn = document.querySelector('#sponsorRegisterForm button[type="submit"], #sponsorRegisterForm input[type="submit"]');
            const unlockStatus = document.getElementById('sponsorUnlockStatus');
            let failedAttempts = 0;

            function setLockedState(locked) {
              if (!regFields) return;
              for (const el of regFields.querySelectorAll('input, select, textarea')) {
                el.disabled = locked;
              }
              if (submitBtn) submitBtn.disabled = locked;
            }

            async function tryUnlock() {
              const key = (accessInput && accessInput.value ? accessInput.value.trim() : '');
              if (!key) return;
              try {
                const resp = await fetch('/api/sponsor/validate-key', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ key })
                });
                const data = await resp.json();
                if (data && data.ok) {
                  localStorage.setItem('bp_sponsor_access_code', key);
                  setLockedState(false);
                  if (accessInput) {
                    accessInput.classList.remove('is-invalid');
                    accessInput.classList.add('is-valid');
                  }
                  if (unlockStatus) unlockStatus.style.display = 'block';
                } else {
                  failedAttempts++;
                  if (accessInput) {
                    accessInput.classList.remove('is-valid');
                    accessInput.classList.add('is-invalid');
                  }
                  if (failedAttempts >= 3) {
                    window.location.href = 'https://www.google.com/';
                  }
                }
              } catch (e) {
                failedAttempts++;
                if (accessInput) {
                  accessInput.classList.remove('is-valid');
                  accessInput.classList.add('is-invalid');
                }
                if (failedAttempts >= 3) {
                  window.location.href = 'https://www.google.com/';
                }
              }
            }

            if (accessConfigured) {
              setLockedState(true);
              const unlockBtn = document.getElementById('sponsorUnlockSubmit');
              const clearBtn = document.getElementById('sponsorUnlockClear');
              if (unlockBtn) unlockBtn.addEventListener('click', tryUnlock);
              if (clearBtn) {
                clearBtn.addEventListener('click', function() {
                  localStorage.removeItem('bp_sponsor_access_code');
                  if (accessInput) accessInput.value = '';
                  setLockedState(true);
                  if (accessInput) {
                    accessInput.classList.remove('is-valid');
                    accessInput.classList.remove('is-invalid');
                  }
                  if (unlockStatus) unlockStatus.style.display = 'none';
                });
              }

              const saved = localStorage.getItem('bp_sponsor_access_code');
              if (saved && accessInput) {
                accessInput.value = saved;
                tryUnlock();
              }
            } else {
              setLockedState(false);
            }
          });
        </script>
      </div>
    </div>
  </div>
{% endblock %}

{% extends "base.html" %}
{% block content %}
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h2 class="mb-0">AA Sponsor Registry</h2>
      </div>

      <div class="alert alert-info">
        <strong>Purpose:</strong> This form helps the Back Porch team understand sponsor availability and connect members who request sponsorship.
        <div class="small mt-2">
          Your information is intended for internal use by admins. Contact info is optional, but helps us follow up.
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <form id="sponsorRegisterForm" method="post" novalidate>
            {{ form.hidden_tag() }}

            {% if access_codes_configured %}
            <!-- Sponsor Key Section (mirrors chairperson registration gating) -->
            <div class="mb-4 p-3 border rounded" style="background-color: var(--bp-gold-light); border-color: var(--bp-gold) !important;">
              <div class="d-flex align-items-center mb-2">
                <i class="fas fa-key text-warning me-2" style="font-size: 1.5rem;"></i>
                <h5 class="mb-0">BP Sponsor Key Required</h5>
              </div>

              <div class="alert alert-light border mb-3" role="alert">
                <i class="fas fa-info-circle"></i> <strong>Sponsor registration is locked.</strong> Enter your BP Sponsor Key to unlock the form.
              </div>

              <label for="sponsor_access_code" class="form-label fw-bold">Enter Your BP Sponsor Key:</label>
              <div class="input-group mb-2">
                {{ form.access_code(class='form-control', id='sponsor_access_code', placeholder='Enter BP Sponsor Key', autocomplete='off') }}
                <button type="button" id="sponsorUnlockSubmit" class="btn btn-primary">
                  <i class="fas fa-unlock"></i> Submit
                </button>
                <button type="button" id="sponsorUnlockClear" class="btn btn-outline-secondary">
                  <i class="fas fa-times"></i> Clear
                </button>
              </div>

              <div class="card mt-3" style="border: 2px solid var(--bp-green); background-color: var(--bp-green);">
                <div class="card-body p-3">
                  <h6 class="card-title mb-2" style="color: white;">
                    <i class="fas fa-envelope"></i> Need a BP Sponsor Key?
                  </h6>
                  <p class="card-text small mb-2" style="color: white;">
                    Request a BP-Sponsor-Key from Back Porch, and you’ll receive a key after verification.
                  </p>
                  <a href="mailto:backporchmeetings@outlook.com?subject=Request%20BP%20Sponsor%20Key&body=Hello,%0D%0A%0D%0AI would like to request a BP Sponsor Key to register as a sponsor.%0D%0A%0D%0AThank you!" 
                     class="btn btn-gold btn-sm w-100">
                    <i class="fas fa-paper-plane"></i> Request a BP Sponsor Key
                  </a>
                </div>
              </div>

              <div id="sponsorUnlockStatus" class="mt-3" style="display: none;">
                <div class="alert alert-success mb-0" role="alert">
                  <i class="fas fa-check-circle"></i> <strong>Form Unlocked!</strong> You may now complete sponsor registration below.
                </div>
              </div>
            </div>
            {% endif %}

            <fieldset id="sponsorRegFields">
            <div class="mb-3">
              {{ form.display_name.label(class="form-label") }}
              {{ form.display_name(class="form-control", placeholder="Example: Jeff A.") }}
              {% if form.display_name.errors %}
                <div class="text-danger small mt-1">{{ form.display_name.errors[0] }}</div>
              {% endif %}
            </div>

            <div class="mb-3">
              {{ form.sobriety_date.label(class="form-label") }}
              {{ form.sobriety_date(class="form-control", type="date") }}
              <div class="form-text">Calendar format: YYYY-MM-DD</div>
              {% if form.sobriety_date.errors %}
                <div class="text-danger small mt-1">{{ form.sobriety_date.errors[0] }}</div>
              {% endif %}
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                {{ form.current_sponsees.label(class="form-label") }}
                {{ form.current_sponsees(class="form-control", type="number", min="0") }}
                {% if form.current_sponsees.errors %}
                  <div class="text-danger small mt-1">{{ form.current_sponsees.errors[0] }}</div>
                {% endif %}
              </div>
              <div class="col-md-6 mb-3">
                {{ form.max_sponsees.label(class="form-label") }}
                {{ form.max_sponsees(class="form-control", type="number", min="0") }}
                {% if form.max_sponsees.errors %}
                  <div class="text-danger small mt-1">{{ form.max_sponsees.errors[0] }}</div>
                {% endif %}
              </div>
            </div>

            <hr>

            <div class="row">
              <div class="col-md-6 mb-3">
                {{ form.email.label(class="form-label") }}
                {{ form.email(class="form-control", placeholder="name@example.com") }}
                {% if form.email.errors %}
                  <div class="text-danger small mt-1">{{ form.email.errors[0] }}</div>
                {% endif %}
              </div>
              <div class="col-md-6 mb-3">
                {{ form.phone.label(class="form-label") }}
                {{ form.phone(class="form-control", placeholder="Optional") }}
                {% if form.phone.errors %}
                  <div class="text-danger small mt-1">{{ form.phone.errors[0] }}</div>
                {% endif %}
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                {{ form.preferred_contact.label(class="form-label") }}
                {{ form.preferred_contact(class="form-select") }}
                {% if form.preferred_contact.errors %}
                  <div class="text-danger small mt-1">{{ form.preferred_contact.errors[0] }}</div>
                {% endif %}
              </div>
              <div class="col-md-6 mb-3">
                {{ form.gender.label(class="form-label") }}
                {{ form.gender(class="form-select") }}
                {% if form.gender.errors %}
                  <div class="text-danger small mt-1">{{ form.gender.errors[0] }}</div>
                {% endif %}
              </div>
            </div>

            <div class="mb-3">
              {{ form.timezone.label(class="form-label") }}
              {{ form.timezone(class="form-control", placeholder="Example: America/Denver") }}
              <div class="form-text">Optional, but useful if you’re in a different time zone.</div>
              {% if form.timezone.errors %}
                <div class="text-danger small mt-1">{{ form.timezone.errors[0] }}</div>
              {% endif %}
            </div>

            <div class="mb-3">
              {{ form.notes.label(class="form-label") }}
              {{ form.notes(class="form-control", rows="4", placeholder="Optional: sponsorship preferences, availability, etc.") }}
              {% if form.notes.errors %}
                <div class="text-danger small mt-1">{{ form.notes.errors[0] }}</div>
              {% endif %}
            </div>

            <div class="d-flex gap-2">
              {{ form.submit(class="btn btn-primary") }}
              <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">Back to Home</a>
            </div>
            </fieldset>
          </form>
        </div>
      </div>

      <script>
        document.addEventListener('DOMContentLoaded', function() {
          const accessConfigured = {{ 'true' if access_codes_configured else 'false' }};
          const accessInput = document.getElementById('sponsor_access_code');
          const regFields = document.getElementById('sponsorRegFields');
          const submitBtn = document.querySelector('#sponsorRegisterForm button[type="submit"], #sponsorRegisterForm input[type="submit"]');
          const unlockStatus = document.getElementById('sponsorUnlockStatus');
          let failedAttempts = 0;

          function setLockedState(locked) {
            if (!regFields) return;
            for (const el of regFields.querySelectorAll('input, select, textarea')) {
              el.disabled = locked;
            }
            if (submitBtn) submitBtn.disabled = locked;
          }

          async function tryUnlock() {
            const key = (accessInput && accessInput.value ? accessInput.value.trim() : '');
            if (!key) return;
            try {
              const resp = await fetch('/api/sponsor/validate-key', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key })
              });
              const data = await resp.json();
              if (data && data.ok) {
                localStorage.setItem('bp_sponsor_access_code', key);
                setLockedState(false);
                if (accessInput) {
                  accessInput.classList.remove('is-invalid');
                  accessInput.classList.add('is-valid');
                }
                if (unlockStatus) unlockStatus.style.display = 'block';
              } else {
                failedAttempts++;
                if (accessInput) {
                  accessInput.classList.remove('is-valid');
                  accessInput.classList.add('is-invalid');
                }
                if (failedAttempts >= 3) {
                  window.location.href = 'https://www.google.com/';
                }
              }
            } catch (e) {
              failedAttempts++;
              if (accessInput) {
                accessInput.classList.remove('is-valid');
                accessInput.classList.add('is-invalid');
              }
              if (failedAttempts >= 3) {
                window.location.href = 'https://www.google.com/';
              }
            }
          }

          if (accessConfigured) {
            setLockedState(true);
            const unlockBtn = document.getElementById('sponsorUnlockSubmit');
            const clearBtn = document.getElementById('sponsorUnlockClear');
            if (unlockBtn) unlockBtn.addEventListener('click', tryUnlock);
            if (clearBtn) {
              clearBtn.addEventListener('click', function() {
                localStorage.removeItem('bp_sponsor_access_code');
                if (accessInput) accessInput.value = '';
                setLockedState(true);
                if (accessInput) {
                  accessInput.classList.remove('is-valid');
                  accessInput.classList.remove('is-invalid');
                }
                if (unlockStatus) unlockStatus.style.display = 'none';
              });
            }

            const saved = localStorage.getItem('bp_sponsor_access_code');
            if (saved && accessInput) {
              accessInput.value = saved;
              tryUnlock();
            }
          } else {
            setLockedState(false);
          }
        });
      </script>
    </div>
  </div>
{% endblock %}

