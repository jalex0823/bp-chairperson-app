{% extends "base.html" %}
{% block content %}
<style>
  /* Sidebar (dark portion) */
  .calendar-layout { display: grid; grid-template-columns: 300px 1fr; gap: 1.5rem; }
  @media (max-width: 992px) { .calendar-layout { grid-template-columns: 1fr; } }
  .calendar-sidebar { background: #1e1e1e; color: #e7e9ec; border-radius: .75rem; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,.1); }
  .calendar-sidebar .sidebar-header { padding: 1rem 1.25rem; border-bottom: 1px solid rgba(255,255,255,.08); display:flex; align-items:center; gap:.5rem; }
  .calendar-sidebar .mini-calendar { padding: .75rem 1.25rem; font-size: .95rem; color: #fff; font-weight: 600; border-bottom: 1px solid rgba(255,255,255,.06); }
  .calendar-sidebar .mini-calendar .year { color: #ff6b6b; margin-left: .25rem; }
  .calendar-sidebar .list-section { padding: 1rem 1.25rem; }
  .calendar-sidebar .list-title { color: #9ca3af; font-size: .75rem; margin-bottom: .75rem; letter-spacing: .05em; text-transform: uppercase; font-weight: 600; }
  .calendar-sidebar .meeting-item { padding: .75rem; border-radius: .5rem; background: rgba(255,255,255,.06); margin-bottom: .5rem; border-left: 3px solid #3b82f6; }
  .calendar-sidebar .meeting-item .time { color:#60a5fa; font-weight: 700; font-size: .85rem; display: block; margin-bottom: .25rem; }
  .calendar-sidebar .meeting-item .title { color:#e7e9ec; font-weight: 600; font-size: .9rem; display: block; margin-bottom: .25rem; }
  .calendar-sidebar .meeting-item .chair { color:#9ca3af; font-size: .8rem; }
  .calendar-sidebar .weather { padding: .5rem 0; color: #9ca3af; font-size: .85rem; }

  /* Month grid (main calendar) */
  .calendar-main { background: white; border-radius: .75rem; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,.08); }
  .calendar-table { margin-bottom: 0; }
  .calendar-table thead th { 
    text-transform: uppercase; 
    font-size: .65rem; 
    letter-spacing: .08em; 
    padding: .75rem .4rem;
    font-weight: 700;
    color: #6b7280;
    background: #f9fafb;
    border: none;
    text-align: left;
  }
  .calendar-cell { 
    min-height: 95px; 
    border: 1px solid #e5e7eb; 
    padding: .4rem;
    vertical-align: top;
    background: white;
    position: relative;
  }
  .calendar-cell:hover { background: #f9fafb; }
  .calendar-out-month { background-color: #fafafa; color: #9ca3af; }
  .calendar-out-month:hover { background-color: #f5f5f5; }
  .calendar-cell .day-number { 
    font-weight: 600; 
    font-size: .85rem; 
    color: #374151;
    margin-bottom: .35rem;
  }
  .calendar-out-month .day-number { color: #9ca3af; }
  
  /* Today indicator */
  .calendar-cell.today { background: #eff6ff; }
  .calendar-cell.today .day-number { 
    background: #3b82f6; 
    color: white; 
    width: 26px; 
    height: 26px; 
    border-radius: 50%; 
    display: inline-flex; 
    align-items: center; 
    justify-content: center;
    font-size: .85rem;
  }

  /* Meeting items in calendar */
  .meeting-badge { 
    font-size: .7rem; 
    padding: .25rem .45rem; 
    border-radius: .3rem; 
    margin-bottom: .25rem; 
    display: block;
    text-decoration: none;
    color: white;
    font-weight: 500;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    border-left: 2px solid rgba(255,255,255,.3);
    transition: all .15s ease;
  }
  .meeting-badge:hover { 
    transform: translateX(2px);
    box-shadow: 0 2px 4px rgba(0,0,0,.15);
    color: white;
  }
  .meeting-badge.has-chair { background: #10b981; }
  .meeting-badge.no-chair { background: #6b7280; }
  .meeting-badge.special { background: #f59e0b; }
  .meeting-badge.holiday { background: #ef4444; }
  
  /* Weather icons */
  .weather-icon { font-size: 1.2rem; opacity: .6; }
  
  .meeting-title { display:inline-block; max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  
  /* Print styles - ensure calendar fits on one page */
  @media print {
    /* Hide navigation, sidebar, and UI elements */
    nav, .navbar, .calendar-sidebar, .btn, .dropdown, .btn-group, form, .alert { display: none !important; }
    
    /* Remove backgrounds and shadows for print */
    body { background: white !important; }
    .calendar-main { box-shadow: none !important; border: 1px solid #ddd; }
    .calendar-layout { grid-template-columns: 1fr !important; }
    
    /* Ensure calendar fits on one page */
    @page { size: landscape; margin: 0.5cm; }
    .calendar-main { 
      page-break-after: avoid; 
      page-break-inside: avoid; 
      max-width: 100%; 
      margin: 0;
    }
    .calendar-table { 
      width: 100%; 
      font-size: 9px !important;
      page-break-inside: avoid;
    }
    .calendar-table thead th { 
      padding: 0.3rem 0.25rem !important; 
      font-size: 8px !important;
      background: #f0f0f0 !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
    .calendar-cell { 
      min-height: 80px !important; 
      max-height: 85px !important;
      padding: 0.25rem !important;
      font-size: 8px !important;
      border: 1px solid #ccc !important;
      overflow: hidden;
    }
    .calendar-cell .day-number { 
      font-size: 10px !important; 
      margin-bottom: 0.2rem !important;
    }
    .meeting-badge { 
      font-size: 7px !important; 
      padding: 0.15rem 0.3rem !important;
      margin-bottom: 0.15rem !important;
      border: 1px solid #999;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
    .meeting-badge.has-chair { background: #10b981 !important; border-color: #059669 !important; }
    .meeting-badge.no-chair { background: #6b7280 !important; border-color: #4b5563 !important; }
    .meeting-badge.special { background: #f59e0b !important; border-color: #d97706 !important; }
    .meeting-badge.holiday { background: #ef4444 !important; border-color: #dc2626 !important; }
    
    /* Print header */
    .calendar-main::before {
      content: "{{ month_name }} {{ year }}";
      display: block;
      font-size: 18px;
      font-weight: bold;
      padding: 0.5rem;
      text-align: center;
      border-bottom: 2px solid #333;
      margin-bottom: 0.5rem;
    }
    
    /* Ensure colors print */
    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
  }
  
  /* Mobile responsive styles */
  @media (max-width: 768px) {
    /* Stack layout on mobile */
    .calendar-layout { 
      grid-template-columns: 1fr !important; 
      gap: 1rem;
    }
    
    /* Hide sidebar on mobile, show as collapsible */
    .calendar-sidebar {
      order: -1;
      margin-bottom: 1rem;
    }
    
    /* Compact calendar header */
    .calendar-main .d-flex {
      flex-direction: column;
      align-items: flex-start !important;
      gap: 0.75rem;
    }
    
    .calendar-main h2 {
      font-size: 1.5rem;
    }
    
    /* Smaller cells for mobile */
    .calendar-cell {
      min-height: 70px;
      padding: 0.3rem;
    }
    
    .calendar-cell .day-number {
      font-size: 0.75rem;
      margin-bottom: 0.25rem;
    }
    
    /* Smaller badges */
    .meeting-badge {
      font-size: 0.65rem;
      padding: 0.2rem 0.35rem;
      margin-bottom: 0.2rem;
    }
    
    /* Compact table headers */
    .calendar-table thead th {
      font-size: 0.6rem;
      padding: 0.5rem 0.25rem;
    }
    
    /* View buttons stack better */
    .btn-group {
      flex-wrap: wrap;
    }
    
    /* Search form */
    .input-group {
      flex-wrap: wrap;
    }
    
    .input-group .form-control {
      min-width: 100%;
      margin-bottom: 0.5rem;
    }
  }
  
  /* Very small phones */
  @media (max-width: 576px) {
    .calendar-cell {
      min-height: 60px;
      padding: 0.25rem;
    }
    
    .calendar-cell .day-number {
      font-size: 0.7rem;
    }
    
    .meeting-badge {
      font-size: 0.6rem;
      padding: 0.15rem 0.3rem;
    }
    
    .calendar-table thead th {
      font-size: 0.55rem;
      padding: 0.4rem 0.2rem;
    }
    
    /* Hide sidebar sections on very small screens */
    .calendar-sidebar .list-section {
      padding: 0.75rem 1rem;
    }
  }
</style>
<div class="calendar-layout">
  <!-- Dark sidebar -->
  <aside class="calendar-sidebar">
    <div class="sidebar-header">
      <span class="fw-bold fs-5">January<span class="year">{{ year }}</span></span>
    </div>
    <div class="mini-calendar">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <button class="btn btn-sm btn-link text-white p-0" onclick="navigateMonth(-1)">â—€</button>
        <span>{{ month_name }} {{ year }}</span>
        <button class="btn btn-sm btn-link text-white p-0" onclick="navigateMonth(1)">â–¶</button>
      </div>
      <div class="weather">{{ today.strftime('%A, %B %d') }}</div>
    </div>
    <div class="list-section" id="sidebarToday">
      <div class="list-title">Today {{ today.strftime('%m/%d/%y') }}</div>
      <div class="empty small">Loadingâ€¦</div>
    </div>
    <div class="list-section" id="sidebarTomorrow">
      <div class="list-title">Tomorrow</div>
      <div class="empty small">Loadingâ€¦</div>
    </div>
    <div class="list-section" id="sidebarUpcoming">
      <div class="list-title">This Week</div>
      <div class="empty small">Loadingâ€¦</div>
    </div>
  </aside>

  <div class="calendar-main">
  <div class="d-flex justify-content-between align-items-center mb-3 p-3">
    <h2 class="mb-0 fw-bold">{{ month_name }} {{ year }}</h2>
    <div class="d-flex align-items-center gap-2">
      <div class="btn-group" role="group" aria-label="View options">
        {% set view = request.args.get('view', 'month') %}
        <a class="btn btn-sm {{ 'btn-primary' if view=='day' else 'btn-outline-secondary' }}" href="{{ url_for('calendar_view', year=year, month=month, view='day') }}">Day</a>
        <a class="btn btn-sm {{ 'btn-primary' if view=='week' else 'btn-outline-secondary' }}" href="{{ url_for('calendar_view', year=year, month=month, view='week') }}">Week</a>
        <a class="btn btn-sm {{ 'btn-primary' if view=='month' else 'btn-outline-secondary' }}" href="{{ url_for('calendar_view', year=year, month=month, view='month') }}">Month</a>
        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('calendar_view', year=year, month=month, view='year') }}">Year</a>
      </div>
      {% if allow_nav %}
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('calendar_view', year=today.year, month=today.month) }}">Today</a>
      {% endif %}
      <div class="dropdown">
        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
          <i class="fas fa-ellipsis-h"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" href="{{ url_for('calendar_month_ics', year=year, month=month) }}"><i class="fas fa-download me-2"></i>Download .ics</a></li>
          <li><a class="dropdown-item" href="#" onclick="window.print(); return false;"><i class="fas fa-print me-2"></i>Print</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="https://therealbackporch.com/meetings.html" target="_blank"><i class="fas fa-external-link-alt me-2"></i>Website Meetings</a></li>
        </ul>
      </div>
    </div>
  </div>

<form class="mb-3" method="get" action="{{ url_for('calendar_view') }}">
  <input type="hidden" name="year" value="{{ year }}">
  <input type="hidden" name="month" value="{{ month }}">
  <div class="input-group">
    <input type="text" class="form-control" name="q" placeholder="Search by meeting title or chair name" value="{{ q }}">
    <button class="btn btn-primary" type="submit">Search</button>
    <a class="btn btn-outline-secondary" href="{{ url_for('calendar_view', year=year, month=month) }}">Clear</a>
  </div>
  {% if q %}
    <div class="form-text">Filtering results for: "{{ q }}"</div>
  {% endif %}
</form>

  {% set view = request.args.get('view', 'month') %}
  <div class="table-responsive" {% if view!='month' %}style="display:none"{% endif %}>
{% if not current_user %}
  <div class="alert alert-info d-flex align-items-center" role="alert">
    <div>
      Log in to browse other months and claim an open meeting to chair.
    </div>
    <a class="btn btn-sm btn-outline-primary ms-3" href="{{ url_for('login', next=request.full_path) }}">Log In</a>
    <a class="btn btn-sm btn-outline-secondary ms-2" href="{{ url_for('register', next=request.full_path) }}">Register</a>
  </div>

  <!-- Week view -->
  {% if view == 'week' %}
  <div class="card mb-3">
    <div class="card-header">Week of {{ today.strftime('%b %d, %Y') }}</div>
    <div class="card-body p-0">
      <table class="table table-bordered mb-0">
        <thead class="table-light">
          <tr>
            <th class="text-center">Sun</th>
            <th class="text-center">Mon</th>
            <th class="text-center">Tue</th>
            <th class="text-center">Wed</th>
            <th class="text-center">Thu</th>
            <th class="text-center">Fri</th>
            <th class="text-center">Sat</th>
          </tr>
        </thead>
        <tbody>
          {% for week in weeks %}
            {% set contains_today = false %}
            {% for cell in week %}
              {% if cell.date == today %}{% set contains_today = true %}{% endif %}
            {% endfor %}
            {% if contains_today %}
              <tr>
                {% for cell in week %}
                  <td class="p-2" style="vertical-align: top; min-height: 120px;">
                    <div class="d-flex justify-content-between">
                      <strong>{{ cell.date.day }}</strong>
                      {% if cell.date == today %}<span class="badge bg-info text-dark">Today</span>{% endif %}
                    </div>
                    {% if cell.meetings %}
                      <ul class="list-unstyled mt-2 mb-0">
                        {% for m in cell.meetings %}
                          <li class="mb-2">
                            <div class="fw-semibold">{{ m.start_time.strftime('%I:%M %p') }} â€¢ {{ m.title }}</div>
                            <div class="small text-muted">{% if m.chair_signup %}Chair: {{ m.chair_signup.display_name_snapshot }}{% else %}No chair yet{% endif %}</div>
                            <div class="mt-1">
                              {% if m.is_open %}
                                <button class="btn btn-sm btn-outline-success" onclick="claimMeeting({{ m.id }})">Claim</button>
                              {% else %}
                                <button class="btn btn-sm btn-outline-secondary" disabled title="Chair: {{ m.chair_signup.display_name_snapshot if m.chair_signup else '' }}">ðŸ”’ Taken</button>
                              {% endif %}
                            </div>
                          </li>
                        {% endfor %}
                      </ul>
                    {% endif %}
                  </td>
                {% endfor %}
              </tr>
            {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  <!-- Day view -->
  {% if view == 'day' %}
  <div class="card">
    <div class="card-header">{{ today.strftime('%A, %B %d, %Y') }}</div>
    <div class="card-body" id="dayViewBody">Loadingâ€¦</div>
  </div>
  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    const body = document.getElementById('dayViewBody');
    try {
      const resp = await fetch(`/api/day-meetings?date={{ today.strftime('%Y-%m-%d') }}`);
      const data = await resp.json();
      if (!data.meetings || data.meetings.length === 0) { body.innerHTML = '<div class="text-muted">No meetings today.</div>'; return; }
      let html = '<ul class="list-group">';
      for (const m of data.meetings) {
        html += `<li class="list-group-item d-flex justify-content-between align-items-start">
          <div>
            <div class="fw-bold">${m.time} â€¢ ${m.title}</div>
            <div class="small text-muted">` + (m.chair_name ? `Chair: ${m.chair_name}` : 'No chair yet') + `</div>
          </div>
          <div class="text-nowrap">` + (m.is_open ? `<button class="btn btn-sm btn-outline-success" onclick="claimMeeting(${m.id})">Claim</button>` : `<button class="btn btn-sm btn-outline-secondary" disabled title="Chair: ${m.chair_name || ''}">ðŸ”’ Taken</button>`) + `</div>
        </li>`;
      }
      html += '</ul>';
      body.innerHTML = html;
    } catch (e) { body.innerHTML = '<div class="text-danger">Failed to load.</div>'; }
  });
  </script>
  {% endif %}
{% endif %}
<table class="table table-bordered align-middle calendar-table">
  <thead class="table-light">
    <tr>
      <th class="text-center">Sun</th>
      <th class="text-center">Mon</th>
      <th class="text-center">Tue</th>
      <th class="text-center">Wed</th>
      <th class="text-center">Thu</th>
      <th class="text-center">Fri</th>
      <th class="text-center">Sat</th>
    </tr>
  </thead>
  <tbody>
    {% for week in weeks %}
      <tr>
        {% for cell in week %}
          <td class="calendar-cell {% if not cell.in_month %}calendar-out-month{% endif %} {% if cell.date == today %}today{% endif %}" {% if cell.in_month and cell.date %}data-date="{{ cell.date.strftime('%Y-%m-%d') }}" onclick="openDayModal('{{ cell.date.strftime('%Y-%m-%d') }}')" style="cursor:pointer;"{% endif %}>
            {% if cell.in_month %}
              <div class="day-number">{{ cell.date.day }}</div>
              {% if cell.meetings %}
                <div class="meetings-list">
                  {% for m in cell.meetings %}
                    {% set badge_class = 'has-chair' if m.chair_signup else 'no-chair' %}
                    {% if m.meeting_type == 'Special' %}{% set badge_class = 'special' %}{% endif %}
                    {% if m.meeting_type == 'Holiday' %}{% set badge_class = 'holiday' %}{% endif %}
                    <a href="{{ url_for('meeting_detail', meeting_id=m.id) }}" class="meeting-badge {{ badge_class }}" title="{{ m.start_time.strftime('%I:%M %p') }}{% if m.end_time %} â€“ {{ m.end_time.strftime('%I:%M %p') }}{% endif %} â€¢ {% if m.chair_signup %}Chair: {{ m.chair_signup.display_name_snapshot }}{% else %}No chair yet{% endif %}">
                      {{ m.start_time.strftime('%I:%M %p') }} {{ m.title[:20] }}{% if m.title|length > 20 %}...{% endif %}
                    </a>
                  {% endfor %}
                </div>
              {% endif %}
            {% else %}
              <div class="day-number">{{ cell.date.day if cell.date else '' }}</div>
            {% endif %}
          </td>
        {% endfor %}
      </tr>
    {% endfor %}
  </tbody>
</table>
  </div>
<!-- Day modal -->
<div class="modal fade" id="dayModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dayModalLabel">Meetings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
      <div class="modal-body">
        <div id="dayModalBody">Loadingâ€¦</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
  </div>

<script>
// Enable Bootstrap tooltips
document.addEventListener('DOMContentLoaded', function() {
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
  tooltipTriggerList.forEach(function (el) { new bootstrap.Tooltip(el); });
});
async function openDayModal(dateStr) {
  const modalEl = document.getElementById('dayModal');
  const modalBody = document.getElementById('dayModalBody');
  const titleEl = document.getElementById('dayModalLabel');
  titleEl.textContent = `Meetings â€” ${dateStr}`;
  modalBody.innerHTML = 'Loadingâ€¦';
  const bsModal = new bootstrap.Modal(modalEl);
  bsModal.show();
  try {
    const resp = await fetch(`/api/day-meetings?date=${encodeURIComponent(dateStr)}`);
    const data = await resp.json();
    
    let html = '';
    
    if (!data.meetings || data.meetings.length === 0) {
      html = `<div class="alert alert-info">
        <h6>No meetings scheduled for this day</h6>
        <p class="mb-2">Would you like to volunteer to chair a meeting if one gets scheduled for this date?</p>
        <a href="/volunteer-date/${dateStr}" class="btn btn-primary btn-sm">
          <i class="fas fa-hand"></i> Volunteer to Chair
        </a>
      </div>`;
    } else {
      html = '<ul class="list-group mb-3">';
      for (const m of data.meetings) {
        const takenClass = (!m.is_open) ? ' taken' : '';
        html += `<li class="list-group-item d-flex justify-content-between align-items-start${takenClass}">
          <div>
            <div class="fw-bold">${m.time} â€¢ ${m.title}</div>
            <div class="small text-muted">` + (m.chair_name ? `Chair: ${m.chair_name}` : 'No chair yet') + `</div>
          </div>
          <div class="text-nowrap">` + (m.is_open ? `<button class="btn btn-sm btn-outline-success" onclick="claimMeeting(${m.id})">Claim</button>` : `<button class="btn btn-sm btn-outline-secondary" disabled title="Chair: ${m.chair_name || ''}">ðŸ”’ Taken</button>`) + `</div>
        </li>`;
      }
      html += '</ul>';
      
      // Add volunteer option even when meetings exist
      html += `<div class="border-top pt-3">
        <h6 class="text-muted">Available for additional meetings?</h6>
        <a href="/volunteer-date/${dateStr}" class="btn btn-outline-primary btn-sm">
          <i class="fas fa-plus"></i> Volunteer for More Meetings
        </a>
      </div>`;
    }
    
    modalBody.innerHTML = html;
  } catch (e) {
    modalBody.innerHTML = '<div class="alert alert-danger">Failed to load meetings.</div>';
  }
}

// Populate dark sidebar with Today and Tomorrow
document.addEventListener('DOMContentLoaded', async () => {
  const todayStr = '{{ today.strftime('%Y-%m-%d') }}';
  const tomorrow = new Date(todayStr);
  // Construct tomorrow string safely in JS
  const parts = todayStr.split('-').map(x=>parseInt(x,10));
  const jsDate = new Date(parts[0], parts[1]-1, parts[2]);
  jsDate.setDate(jsDate.getDate()+1);
  const pad = n => String(n).padStart(2,'0');
  const tomorrowStr = `${jsDate.getFullYear()}-${pad(jsDate.getMonth()+1)}-${pad(jsDate.getDate())}`;

  async function fillSection(id, dateStr) {
    const el = document.getElementById(id);
    if (!el) return;
    try {
      const resp = await fetch(`/api/day-meetings?date=${encodeURIComponent(dateStr)}`);
      const data = await resp.json();
      if (!data.meetings || data.meetings.length === 0) {
        el.innerHTML = '<div class="small text-muted">No meetings</div>';
        return;
      }
      let html = '';
      for (const m of data.meetings) {
        html += `<div class="meeting-item">
          <div><span class="time">${m.time}</span><span class="title">${m.title}</span></div>
          <div class="chair">` + (m.chair_name ? `Chair: ${m.chair_name}` : 'No chair yet') + `</div>
        </div>`;
      }
      el.innerHTML = html;
    } catch (e) {
      el.innerHTML = '<div class="small text-danger">Failed to load.</div>';
    }
  }

  await fillSection('sidebarToday', todayStr);
  await fillSection('sidebarTomorrow', tomorrowStr);
  
  // Populate This Week section
  await fillThisWeek(todayStr);
});

async function fillThisWeek(todayStr) {
  const el = document.getElementById('sidebarUpcoming');
  if (!el) return;
  try {
    // Calculate 7 days from today
    const parts = todayStr.split('-').map(x=>parseInt(x,10));
    const startDate = new Date(parts[0], parts[1]-1, parts[2]);
    const endDate = new Date(startDate);
    endDate.setDate(endDate.getDate() + 7);
    
    const pad = n => String(n).padStart(2,'0');
    const startStr = `${startDate.getFullYear()}-${pad(startDate.getMonth()+1)}-${pad(startDate.getDate())}`;
    const endStr = `${endDate.getFullYear()}-${pad(endDate.getMonth()+1)}-${pad(endDate.getDate())}`;
    
    const resp = await fetch(`/api/week-meetings?start=${startStr}&end=${endStr}`);
    const data = await resp.json();
    
    if (!data.meetings || data.meetings.length === 0) {
      el.innerHTML = '<div class="small text-muted">No meetings this week</div>';
      return;
    }
    
    let html = '';
    for (const m of data.meetings.slice(0, 5)) { // Show max 5
      html += `<div class="meeting-item">
        <div><span class="time">${m.date} ${m.time}</span><span class="title">${m.title}</span></div>
        <div class="chair">` + (m.chair_name ? `Chair: ${m.chair_name}` : 'No chair yet') + `</div>
      </div>`;
    }
    el.innerHTML = html;
  } catch (e) {
    el.innerHTML = '<div class="small text-danger">Failed to load.</div>';
  }
}

function navigateMonth(direction) {
  const currentMonth = {{ month }};
  const currentYear = {{ year }};
  let newMonth = currentMonth + direction;
  let newYear = currentYear;
  
  if (newMonth > 12) {
    newMonth = 1;
    newYear++;
  } else if (newMonth < 1) {
    newMonth = 12;
    newYear--;
  }
  
  window.location.href = `/calendar?year=${newYear}&month=${newMonth}`;
}

async function claimMeeting(meetingId) {
  try {
    const resp = await fetch(`/api/meetings/${meetingId}/claim`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    if (resp.status === 401) {
      alert('Please log in to claim a meeting.');
      window.location.href = `/login?next=${encodeURIComponent(window.location.pathname + window.location.search)}`;
      return;
    }
    const data = await resp.json();
    if (!data.ok) {
      alert('Unable to claim meeting: ' + (data.error || 'unknown error'));
      return;
    }
    // Reload page to reflect claim
    window.location.reload();
  } catch (e) {
    alert('Failed to claim meeting.');
  }
}
</script>
{% endblock %}
