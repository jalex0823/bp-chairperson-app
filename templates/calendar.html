{% extends "base.html" %}
{% block content %}
<style>
  /* Sidebar (black portion) */
  .calendar-layout { display: grid; grid-template-columns: 280px 1fr; gap: 1rem; }
  @media (max-width: 992px) { .calendar-layout { grid-template-columns: 1fr; } }
  .calendar-sidebar { background: #121416; color: #e7e9ec; border-radius: .5rem; overflow: hidden; }
  .calendar-sidebar .sidebar-header { padding: .75rem 1rem; border-bottom: 1px solid rgba(255,255,255,.08); display:flex; align-items:center; gap:.5rem; }
  .calendar-sidebar .mini-calendar { padding: .5rem 1rem; font-size: .9rem; color: #b8bdc3; border-bottom: 1px solid rgba(255,255,255,.06); }
  .calendar-sidebar .list-section { padding: .75rem 1rem; }
  .calendar-sidebar .list-title { color: #b8bdc3; font-size: .85rem; margin-bottom: .5rem; letter-spacing: .02em; }
  .calendar-sidebar .meeting-item { padding: .5rem; border-radius: .375rem; background: rgba(255,255,255,.05); margin-bottom: .5rem; }
  .calendar-sidebar .meeting-item .time { color:#6dd3ff; font-weight: 600; margin-right: .5rem; }
  .calendar-sidebar .meeting-item .title { color:#e7e9ec; font-weight: 600; }
  .calendar-sidebar .meeting-item .chair { color:#b8bdc3; font-size: .85rem; }

  /* Month grid (white portion) */
  .calendar-table thead th { text-transform: uppercase; font-size: .8rem; letter-spacing: .04em; }
  .calendar-cell { min-height: 140px; border: 1px solid #dee2e6; }
  .calendar-out-month { background-color: #f7f7f8; }
  .meeting-title { display:inline-block; max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
</style>
<div class="calendar-layout">
  <!-- Dark sidebar -->
  <aside class="calendar-sidebar">
    <div class="sidebar-header">
      <span class="fw-bold">Back Porch</span>
      <span class="ms-auto small">{{ today.strftime('%b %d, %Y') }}</span>
    </div>
    <div class="mini-calendar">
      {{ month_name }} {{ year }}
    </div>
    <div class="list-section" id="sidebarToday">
      <div class="list-title">Today</div>
      <div class="empty small">Loadingâ€¦</div>
    </div>
    <div class="list-section" id="sidebarTomorrow">
      <div class="list-title">Tomorrow</div>
      <div class="empty small">Loadingâ€¦</div>
    </div>
  </aside>

  <div>
  <div class="d-flex justify-content-between align-items-center mb-3 calendar-header shadow-sm w-100">
  <h1 class="mb-0">{{ month_name }} {{ year }}</h1>
    <div class="d-flex align-items-center gap-2">
      {% if allow_nav %}
      <a class="btn btn-light btn-sm rounded-pill" href="{{ url_for('calendar_view', year=prev_year, month=prev_month) }}">â—€ Prev</a>
      <a class="btn btn-light btn-sm rounded-pill" href="{{ url_for('calendar_view', year=next_year, month=next_month) }}">Next â–¶</a>
      <a class="btn btn-light btn-sm rounded-pill" href="{{ url_for('calendar_view', year=today.year, month=today.month) }}">Today</a>
      {% else %}
      <a class="btn btn-light btn-sm rounded-pill" href="{{ url_for('calendar_display') }}">Current Month</a>
      {% endif %}
      <a class="btn btn-light btn-sm rounded-pill" href="{{ url_for('calendar_month_ics', year=year, month=month) }}">Download .ics</a>
      <button class="btn btn-light btn-sm rounded-pill" onclick="window.print()">Print</button>
      <a class="btn btn-outline-secondary btn-sm rounded-pill" href="https://therealbackporch.com/meetings.html" target="_blank" rel="noopener">Website Meetings Page</a>
      <div class="btn-group ms-2" role="group" aria-label="View options">
        {% set view = request.args.get('view', 'month') %}
        <a class="btn btn-sm {{ 'btn-primary' if view=='day' else 'btn-light' }}" href="{{ url_for('calendar_view', year=year, month=month, view='day') }}">Day</a>
        <a class="btn btn-sm {{ 'btn-primary' if view=='week' else 'btn-light' }}" href="{{ url_for('calendar_view', year=year, month=month, view='week') }}">Week</a>
        <a class="btn btn-sm {{ 'btn-primary' if view=='month' else 'btn-light' }}" href="{{ url_for('calendar_view', year=year, month=month, view='month') }}">Month</a>
      </div>
    </div>
  </div>

<form class="mb-3" method="get" action="{{ url_for('calendar_view') }}">
  <input type="hidden" name="year" value="{{ year }}">
  <input type="hidden" name="month" value="{{ month }}">
  <div class="input-group">
    <input type="text" class="form-control" name="q" placeholder="Search by meeting title or chair name" value="{{ q }}">
    <button class="btn btn-primary" type="submit">Search</button>
    <a class="btn btn-outline-secondary" href="{{ url_for('calendar_view', year=year, month=month) }}">Clear</a>
  </div>
  {% if q %}
    <div class="form-text">Filtering results for: "{{ q }}"</div>
  {% endif %}
</form>

  {% set view = request.args.get('view', 'month') %}
  <div class="table-responsive" {% if view!='month' %}style="display:none"{% endif %}>
{% if not current_user %}
  <div class="alert alert-info d-flex align-items-center" role="alert">
    <div>
      Log in to browse other months and claim an open meeting to chair.
    </div>
    <a class="btn btn-sm btn-outline-primary ms-3" href="{{ url_for('login', next=request.full_path) }}">Log In</a>
    <a class="btn btn-sm btn-outline-secondary ms-2" href="{{ url_for('register', next=request.full_path) }}">Register</a>
  </div>

  <!-- Week view -->
  {% if view == 'week' %}
  <div class="card mb-3">
    <div class="card-header">Week of {{ today.strftime('%b %d, %Y') }}</div>
    <div class="card-body p-0">
      <table class="table table-bordered mb-0">
        <thead class="table-light">
          <tr>
            <th class="text-center">Sun</th>
            <th class="text-center">Mon</th>
            <th class="text-center">Tue</th>
            <th class="text-center">Wed</th>
            <th class="text-center">Thu</th>
            <th class="text-center">Fri</th>
            <th class="text-center">Sat</th>
          </tr>
        </thead>
        <tbody>
          {% for week in weeks %}
            {% set contains_today = false %}
            {% for cell in week %}
              {% if cell.date == today %}{% set contains_today = true %}{% endif %}
            {% endfor %}
            {% if contains_today %}
              <tr>
                {% for cell in week %}
                  <td class="p-2" style="vertical-align: top; min-height: 120px;">
                    <div class="d-flex justify-content-between">
                      <strong>{{ cell.date.day }}</strong>
                      {% if cell.date == today %}<span class="badge bg-info text-dark">Today</span>{% endif %}
                    </div>
                    {% if cell.meetings %}
                      <ul class="list-unstyled mt-2 mb-0">
                        {% for m in cell.meetings %}
                          <li class="mb-2">
                            <div class="fw-semibold">{{ m.start_time.strftime('%I:%M %p') }} â€¢ {{ m.title }}</div>
                            <div class="small text-muted">{% if m.chair_signup %}Chair: {{ m.chair_signup.display_name_snapshot }}{% else %}No chair yet{% endif %}</div>
                            <div class="mt-1">
                              {% if m.is_open %}
                                <button class="btn btn-sm btn-outline-success" onclick="claimMeeting({{ m.id }})">Claim</button>
                              {% else %}
                                <button class="btn btn-sm btn-outline-secondary" disabled title="Chair: {{ m.chair_signup.display_name_snapshot if m.chair_signup else '' }}">ðŸ”’ Taken</button>
                              {% endif %}
                            </div>
                          </li>
                        {% endfor %}
                      </ul>
                    {% endif %}
                  </td>
                {% endfor %}
              </tr>
            {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  <!-- Day view -->
  {% if view == 'day' %}
  <div class="card">
    <div class="card-header">{{ today.strftime('%A, %B %d, %Y') }}</div>
    <div class="card-body" id="dayViewBody">Loadingâ€¦</div>
  </div>
  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    const body = document.getElementById('dayViewBody');
    try {
      const resp = await fetch(`/api/day-meetings?date={{ today.strftime('%Y-%m-%d') }}`);
      const data = await resp.json();
      if (!data.meetings || data.meetings.length === 0) { body.innerHTML = '<div class="text-muted">No meetings today.</div>'; return; }
      let html = '<ul class="list-group">';
      for (const m of data.meetings) {
        html += `<li class="list-group-item d-flex justify-content-between align-items-start">
          <div>
            <div class="fw-bold">${m.time} â€¢ ${m.title}</div>
            <div class="small text-muted">` + (m.chair_name ? `Chair: ${m.chair_name}` : 'No chair yet') + `</div>
          </div>
          <div class="text-nowrap">` + (m.is_open ? `<button class="btn btn-sm btn-outline-success" onclick="claimMeeting(${m.id})">Claim</button>` : `<button class="btn btn-sm btn-outline-secondary" disabled title="Chair: ${m.chair_name || ''}">ðŸ”’ Taken</button>`) + `</div>
        </li>`;
      }
      html += '</ul>';
      body.innerHTML = html;
    } catch (e) { body.innerHTML = '<div class="text-danger">Failed to load.</div>'; }
  });
  </script>
  {% endif %}
{% endif %}
<table class="table table-bordered align-middle calendar-table">
  <thead class="table-light">
    <tr>
      <th class="text-center">Sun</th>
      <th class="text-center">Mon</th>
      <th class="text-center">Tue</th>
      <th class="text-center">Wed</th>
      <th class="text-center">Thu</th>
      <th class="text-center">Fri</th>
      <th class="text-center">Sat</th>
    </tr>
  </thead>
  <tbody>
    {% for week in weeks %}
      <tr>
        {% for cell in week %}
          <td class="p-2 calendar-cell {% if not cell.in_month %}calendar-out-month{% endif %}" style="vertical-align: top;" {% if cell.in_month and cell.date %}data-date="{{ cell.date.strftime('%Y-%m-%d') }}" onclick="openDayModal('{{ cell.date.strftime('%Y-%m-%d') }}')" style="cursor:pointer;"{% endif %}>
            {% if cell.in_month %}
              <div class="d-flex justify-content-between">
                <strong>{{ cell.date.day }}</strong>
                {% if cell.date == today %}<span class="badge bg-info text-dark">Today</span>{% endif %}
              </div>
              {% if cell.meetings %}
                <ul class="list-unstyled mt-2 mb-0">
                  {% for m in cell.meetings %}
                    <li class="mb-2 meeting {% if m.chair_signup %}chaired{% endif %}">
                      <div class="fw-semibold">
                        <a href="{{ url_for('meeting_detail', meeting_id=m.id) }}" class="text-decoration-none meeting-title">{{ m.title }}</a>
                      </div>
                      <div class="text-muted small meeting-time">
                        {{ m.start_time.strftime('%I:%M %p') }}{% if m.end_time %} â€“ {{ m.end_time.strftime('%I:%M %p') }}{% endif %}
                      </div>
                      <div class="small meeting-chair">
                        {% if m.chair_signup %}
                          <span>Chair: {{ m.chair_signup.display_name_snapshot }}</span>
                        {% else %}
                          <span class="text-muted">No chair yet</span>
                        {% endif %}
                      </div>
                    </li>
                  {% endfor %}
                </ul>
              {% endif %}
            {% endif %}
          </td>
        {% endfor %}
      </tr>
    {% endfor %}
  </tbody>
</table>
  </div>
<!-- Day modal -->
<div class="modal fade" id="dayModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dayModalLabel">Meetings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
      <div class="modal-body">
        <div id="dayModalBody">Loadingâ€¦</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
  </div>

<script>
// Enable Bootstrap tooltips
document.addEventListener('DOMContentLoaded', function() {
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
  tooltipTriggerList.forEach(function (el) { new bootstrap.Tooltip(el); });
});
async function openDayModal(dateStr) {
  const modalEl = document.getElementById('dayModal');
  const modalBody = document.getElementById('dayModalBody');
  const titleEl = document.getElementById('dayModalLabel');
  titleEl.textContent = `Meetings â€” ${dateStr}`;
  modalBody.innerHTML = 'Loadingâ€¦';
  const bsModal = new bootstrap.Modal(modalEl);
  bsModal.show();
  try {
    const resp = await fetch(`/api/day-meetings?date=${encodeURIComponent(dateStr)}`);
    const data = await resp.json();
    if (!data.meetings || data.meetings.length === 0) {
      modalBody.innerHTML = '<div class="alert alert-info">No meetings scheduled for this day.</div>';
      return;
    }
    let html = '<ul class="list-group">';
    for (const m of data.meetings) {
      const takenClass = (!m.is_open) ? ' taken' : '';
      html += `<li class="list-group-item d-flex justify-content-between align-items-start${takenClass}">
        <div>
          <div class="fw-bold">${m.time} â€¢ ${m.title}</div>
          <div class="small text-muted">` + (m.chair_name ? `Chair: ${m.chair_name}` : 'No chair yet') + `</div>
        </div>
        <div class="text-nowrap">` + (m.is_open ? `<button class="btn btn-sm btn-outline-success" onclick="claimMeeting(${m.id})">Claim</button>` : `<button class="btn btn-sm btn-outline-secondary" disabled title="Chair: ${m.chair_name || ''}">ðŸ”’ Taken</button>`) + `</div>
      </li>`;
    }
    html += '</ul>';
    modalBody.innerHTML = html;
  } catch (e) {
    modalBody.innerHTML = '<div class="alert alert-danger">Failed to load meetings.</div>';
  }
}

// Populate dark sidebar with Today and Tomorrow
document.addEventListener('DOMContentLoaded', async () => {
  const todayStr = '{{ today.strftime('%Y-%m-%d') }}';
  const tomorrow = new Date(todayStr);
  // Construct tomorrow string safely in JS
  const parts = todayStr.split('-').map(x=>parseInt(x,10));
  const jsDate = new Date(parts[0], parts[1]-1, parts[2]);
  jsDate.setDate(jsDate.getDate()+1);
  const pad = n => String(n).padStart(2,'0');
  const tomorrowStr = `${jsDate.getFullYear()}-${pad(jsDate.getMonth()+1)}-${pad(jsDate.getDate())}`;

  async function fillSection(id, dateStr) {
    const el = document.getElementById(id);
    if (!el) return;
    try {
      const resp = await fetch(`/api/day-meetings?date=${encodeURIComponent(dateStr)}`);
      const data = await resp.json();
      if (!data.meetings || data.meetings.length === 0) {
        el.innerHTML = '<div class="small text-muted">No meetings</div>';
        return;
      }
      let html = '';
      for (const m of data.meetings) {
        html += `<div class="meeting-item">
          <div><span class="time">${m.time}</span><span class="title">${m.title}</span></div>
          <div class="chair">` + (m.chair_name ? `Chair: ${m.chair_name}` : 'No chair yet') + `</div>
        </div>`;
      }
      el.innerHTML = html;
    } catch (e) {
      el.innerHTML = '<div class="small text-danger">Failed to load.</div>';
    }
  }

  await fillSection('sidebarToday', todayStr);
  await fillSection('sidebarTomorrow', tomorrowStr);
});

async function claimMeeting(meetingId) {
  try {
    const resp = await fetch(`/api/meetings/${meetingId}/claim`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    if (resp.status === 401) {
      alert('Please log in to claim a meeting.');
      window.location.href = `/login?next=${encodeURIComponent(window.location.pathname + window.location.search)}`;
      return;
    }
    const data = await resp.json();
    if (!data.ok) {
      alert('Unable to claim meeting: ' + (data.error || 'unknown error'));
      return;
    }
    // Reload page to reflect claim
    window.location.reload();
  } catch (e) {
    alert('Failed to claim meeting.');
  }
}
</script>
{% endblock %}
