{% extends "base.html" %}
{% block content %}
  <h2>Reset Sponsor Password</h2>

  <p class="text-muted" style="max-width: 520px;">
    Enter the email address for your sponsor portal account. If it exists, you can set a new password immediately (no email required).
  </p>

  <form method="post" action="{{ url_for('sponsor_forgot_password') }}" class="mt-3" style="max-width: 420px;" autocomplete="on">
    {{ form.hidden_tag() }}
    {{ form.step(value="email") }}

    <div class="mb-3">
      {{ form.email.label(class="form-label") }}
      {{ form.email(class="form-control",
                    type="email",
                    autocomplete="username",
                    autocapitalize="none",
                    autocorrect="off",
                    spellcheck="false",
                    inputmode="email",
                    enterkeyhint="send",
                    placeholder="your.email@example.com") }}
    </div>

    <button type="submit" class="btn btn-primary w-100">Continue</button>
    <div class="form-text mt-2">
      Tip: Your sponsor password is separate from your chairperson password.
    </div>
  </form>

  {% if show_reset_fields and verified_email %}
    <hr class="my-4" style="max-width: 520px;">

    <div class="card shadow-sm" style="max-width: 520px;">
      <div class="card-body">
        <div class="mb-2"><strong>Set a new sponsor password</strong></div>
        <div class="small text-muted mb-3">Verified email: <strong>{{ verified_email }}</strong></div>

        <form method="post" action="{{ url_for('sponsor_forgot_password') }}" autocomplete="on">
          {{ form.hidden_tag() }}
          {{ form.step(value="reset") }}
          <input type="hidden" name="{{ form.email.name }}" value="{{ verified_email }}">

          <div class="mb-3">
            <label class="form-label" for="new_password">New Password</label>
            <input id="new_password"
                   name="{{ form.new_password.name }}"
                   class="form-control"
                   type="password"
                   autocomplete="new-password"
                   autocapitalize="none"
                   autocorrect="off"
                   spellcheck="false"
                   enterkeyhint="next"
                   placeholder="New password">
          </div>

          <div class="mb-3">
            <label class="form-label" for="confirm_password">Confirm New Password</label>
            <input id="confirm_password"
                   name="{{ form.confirm_password.name }}"
                   class="form-control"
                   type="password"
                   autocomplete="new-password"
                   autocapitalize="none"
                   autocorrect="off"
                   spellcheck="false"
                   enterkeyhint="done"
                   placeholder="Confirm new password">
          </div>

          <button type="submit" class="btn btn-primary w-100">Save New Sponsor Password</button>
        </form>
      </div>
    </div>
  {% endif %}

  <p class="mt-3">
    <a href="{{ url_for('sponsor_login') }}">Back to sponsor login</a>
  </p>

  <!-- Success modal -->
  <div class="modal fade" id="sponsorResetSuccessModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">Password reset successful</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Your sponsor password has been updated. Redirecting you back to Sponsor Loginâ€¦
        </div>
      </div>
    </div>
  </div>

  {% if reset_success %}
    <script>
      (function() {
        try {
          const el = document.getElementById('sponsorResetSuccessModal');
          if (el && window.bootstrap) {
            const m = new bootstrap.Modal(el);
            m.show();
          }
        } catch (e) {}
        setTimeout(function() {
          window.location.href = "{{ url_for('sponsor_login') }}";
        }, 1400);
      })();
    </script>
  {% endif %}
{% endblock %}

